<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ã‚†ã‚‹ã‚¹ã‚±</title>
  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#667eea">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="ã‚†ã‚‹ã‚¹ã‚±">
  <link rel="apple-touch-icon" href="icon-192.svg">
  <meta name="description" content="ã‚†ã‚‹ãäºˆå®šã‚’ç®¡ç†ã™ã‚‹ã‚¢ãƒ—ãƒª">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
      min-height: 100dvh;
    }
    .app {
      max-width: 600px;
      margin: 0 auto;
      min-height: 100vh;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      background: #fff;
    }
    header {
      background: #4a90d9;
      color: white;
      padding: 12px 16px;
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 { font-size: 18px; font-weight: 600; }
    .header-buttons {
      display: flex;
      gap: 8px;
    }
    .header-btn {
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.4);
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
    }
    .header-btn.icon-btn {
      padding: 6px 10px;
      font-size: 16px;
    }
    .header-btn:hover { background: rgba(255,255,255,0.3); }
    .header-btn.support-icon {
      background: #ff9500;
      border-color: #ff9500;
    }
    .header-btn.support-icon:hover {
      background: #e68600;
    }
    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 200;
    }
    .popup {
      background: white;
      border-radius: 12px;
      max-width: 90%;
      max-height: 80%;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .popup-header {
      background: #4a90d9;
      color: white;
      padding: 12px 16px;
      font-weight: 600;
      border-radius: 12px 12px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .popup-close {
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      padding: 0 4px;
    }
    .popup-content {
      padding: 16px;
      line-height: 1.8;
      font-size: 14px;
    }
    .popup-content h3 {
      color: #4a90d9;
      margin-top: 16px;
      margin-bottom: 8px;
      font-size: 15px;
    }
    .popup-content h3:first-child {
      margin-top: 0;
    }
    .popup-content .example {
      color: #666;
      margin-left: 8px;
    }
    .settings-item {
      padding: 12px 0;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .settings-item:last-child {
      border-bottom: none;
    }
    .settings-item.disabled {
      color: #999;
    }
    .settings-item .badge {
      background: #e0e0e0;
      color: #666;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
    }
    .repeat-patterns-section {
      margin: 16px 0;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    .repeat-patterns-header {
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
    }
    .repeat-patterns-list {
      max-height: 200px;
      overflow-y: auto;
    }
    .repeat-pattern-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      background: white;
      border-radius: 6px;
      margin-bottom: 6px;
      font-size: 14px;
    }
    .repeat-pattern-item:last-child {
      margin-bottom: 0;
    }
    .repeat-pattern-info {
      display: flex;
      flex-direction: column;
    }
    .repeat-pattern-title {
      font-weight: 500;
    }
    .repeat-pattern-time {
      font-size: 12px;
      color: #666;
    }
    .repeat-pattern-buttons {
      display: flex;
      gap: 6px;
    }
    .repeat-pattern-edit {
      background: #17a2b8;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
    }
    .repeat-pattern-edit:hover {
      background: #138496;
    }
    .repeat-pattern-delete {
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
    }
    .repeat-pattern-delete:hover {
      background: #c82333;
    }
    .edit-pattern-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }
    .edit-pattern-modal.show {
      display: flex;
    }
    .edit-pattern-content {
      background: white;
      border-radius: 12px;
      padding: 20px;
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .edit-pattern-content h3 {
      margin: 0 0 16px 0;
      font-size: 18px;
    }
    .edit-pattern-field {
      margin-bottom: 16px;
    }
    .edit-pattern-field label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
      color: #333;
    }
    .edit-pattern-field input,
    .edit-pattern-field select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      box-sizing: border-box;
    }
    .edit-pattern-field small {
      display: block;
      margin-top: 4px;
      color: #666;
      font-size: 12px;
    }
    .edit-pattern-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    .edit-pattern-actions button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .edit-pattern-save {
      background: #28a745;
      color: white;
    }
    .edit-pattern-save:hover {
      background: #218838;
    }
    .edit-pattern-cancel {
      background: #6c757d;
      color: white;
    }
    .edit-pattern-cancel:hover {
      background: #5a6268;
    }
    .no-patterns {
      color: #999;
      font-size: 14px;
      text-align: center;
      padding: 8px;
    }
    .detect-patterns-btn {
      width: 100%;
      padding: 10px;
      background: #6c5ce7;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 10px;
    }
    .detect-patterns-btn:hover {
      background: #5b4cdb;
    }
    .detected-patterns-list {
      margin-top: 12px;
      padding: 12px;
      background: #fff3cd;
      border-radius: 8px;
      border: 1px solid #ffc107;
    }
    .detected-patterns-header {
      font-weight: 600;
      font-size: 14px;
      color: #856404;
      margin-bottom: 10px;
    }
    .detected-pattern-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: white;
      border-radius: 6px;
      margin-bottom: 8px;
      border: 1px solid #e0e0e0;
    }
    .detected-pattern-item:last-child {
      margin-bottom: 0;
    }
    .detected-pattern-info {
      flex: 1;
    }
    .detected-pattern-title {
      font-weight: 500;
      font-size: 14px;
    }
    .detected-pattern-detail {
      font-size: 12px;
      color: #666;
      margin-top: 2px;
    }
    .detected-pattern-register {
      background: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
    }
    .detected-pattern-register:hover {
      background: #218838;
    }
    .detected-pattern-register.registered {
      background: #6c757d;
      cursor: default;
    }
    .no-detected-patterns {
      color: #856404;
      font-size: 14px;
      text-align: center;
    }
    .data-btn {
      width: 100%;
      padding: 12px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
    }
    .data-btn:hover {
      background: #0056b3;
    }
    .data-btn:first-of-type {
      margin-top: 16px;
    }
    .support-btn {
      width: 100%;
      padding: 12px;
      background: #ff9500;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 16px;
      text-decoration: none;
      display: block;
      text-align: center;
    }
    .support-btn:hover {
      background: #e68600;
    }
    .delete-all-btn {
      width: 100%;
      padding: 12px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
    }
    .delete-all-btn:hover {
      background: #c82333;
    }
    .main-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .chat-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .message {
      max-width: 85%;
      padding: 10px 14px;
      border-radius: 16px;
      line-height: 1.4;
      font-size: 15px;
    }
    .message.user {
      align-self: flex-end;
      background: #4a90d9;
      color: white;
      border-bottom-right-radius: 4px;
    }
    .message.system {
      align-self: flex-start;
      background: #e8e8e8;
      color: #333;
      border-bottom-left-radius: 4px;
    }
    .message.confirm {
      align-self: flex-start;
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffc107;
      border-bottom-left-radius: 4px;
    }
    .confirm-buttons {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }
    .confirm-buttons button {
      flex: 1;
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-ok { background: #28a745; color: white; }
    .btn-cancel { background: #dc3545; color: white; }
    .btn-delete { background: #dc3545; color: white; }
    .btn-skip { background: #6c757d; color: white; }
    .btn-add { background: #007bff; color: white; }
    .input-form {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      background: #fff;
      border-top: 1px solid #e0e0e0;
    }
    .input-form input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #ddd;
      border-radius: 24px;
      font-size: 16px;
      outline: none;
    }
    .input-form input:focus { border-color: #4a90d9; }
    .input-form input:disabled { background: #f5f5f5; }
    .input-form button {
      padding: 12px 20px;
      background: #4a90d9;
      color: white;
      border: none;
      border-radius: 24px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
    }
    .input-form button:disabled { background: #ccc; }
    .voice-btn {
      padding: 12px 14px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 24px;
      font-size: 18px;
      cursor: pointer;
    }
    .voice-btn:hover { background: #5a6268; }
    .voice-btn.recording {
      background: #dc3545;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    .schedule-text {
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', 'Consolas', monospace;
      line-height: 1.8;
      font-size: 14px;
      white-space: pre-wrap;
    }
    .schedule-text .other-schedule {
      color: #999;
    }
    .copy-schedule-btn {
      display: inline-block;
      margin-top: 10px;
      padding: 6px 12px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
    }
    .copy-schedule-btn:hover {
      background: #5a6268;
    }
    .copy-schedule-btn:active {
      background: #495057;
    }
    @supports (padding-bottom: env(safe-area-inset-bottom)) {
      .input-form {
        padding-bottom: calc(12px + env(safe-area-inset-bottom));
      }
    }
    /* ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒ */
    .toggle-switch {
      position: relative;
      width: 50px;
      height: 26px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      transition: 0.3s;
      border-radius: 26px;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }
    .toggle-switch input:checked + .toggle-slider {
      background-color: #4a90d9;
    }
    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(24px);
    }
    .settings-item select {
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
    /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
    .calendar-popup {
      width: 95vw;
      max-width: 600px;
      height: 85vh;
      max-height: 700px;
      display: flex;
      flex-direction: column;
    }
    .calendar-content {
      padding: 12px;
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .calendar-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      font-weight: 600;
      font-size: 18px;
    }
    .cal-nav-btn {
      background: #4a90d9;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      grid-template-rows: auto repeat(6, 1fr);
      gap: 2px;
      flex: 1;
      overflow: hidden;
    }
    .calendar-grid .day-header {
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      padding: 8px 4px;
      color: #666;
      background: #f8f9fa;
    }
    .calendar-grid .day-header:first-child { color: #dc3545; }
    .calendar-grid .day-header:last-child { color: #007bff; }
    .calendar-grid .day-cell {
      padding: 4px;
      font-size: 12px;
      border-radius: 4px;
      cursor: default;
      min-height: 85px;
      border: 1px solid #eee;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .calendar-grid .day-cell .day-number {
      font-weight: 600;
      margin-bottom: 2px;
    }
    .calendar-grid .day-cell.other-month {
      background: #fafafa;
    }
    .calendar-grid .day-cell.other-month .day-number {
      color: #ccc;
    }
    .calendar-grid .day-cell.today .day-number {
      background: #4a90d9;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .calendar-grid .day-cell.sunday .day-number { color: #dc3545; }
    .calendar-grid .day-cell.saturday .day-number { color: #007bff; }
    .calendar-grid .day-cell.today.sunday .day-number,
    .calendar-grid .day-cell.today.saturday .day-number { color: white; }
    .calendar-grid .day-cell .schedule-item {
      font-size: 11px;
      background: #4a90d9;
      color: white;
      padding: 3px 5px;
      border-radius: 3px;
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
      transition: transform 0.1s;
      position: relative;
    }
    .calendar-grid .day-cell .schedule-item:hover {
      transform: scale(1.02);
      z-index: 10;
    }
    .calendar-grid .day-cell .schedule-item.other {
      background: #78909c;
    }
    .calendar-grid .day-cell .schedule-item.morning {
      background: #43a047;
    }
    .calendar-grid .day-cell .schedule-item.afternoon {
      background: #fb8c00;
    }
    .calendar-grid .day-cell .schedule-item.evening {
      background: #7b1fa2;
    }
    .calendar-grid .day-cell .schedule-more {
      font-size: 11px;
      color: #666;
      margin-top: 2px;
      cursor: pointer;
    }
    .calendar-grid .day-cell .schedule-more:hover {
      color: #4a90d9;
      text-decoration: underline;
    }
    /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— */
    .calendar-tooltip {
      position: fixed;
      background: #333;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 13px;
      max-width: 250px;
      z-index: 1000;
      pointer-events: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    /* æ¤œç´¢ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    .search-overlay {
      position: fixed;
      top: 50px;
      right: 10px;
      background: white;
      padding: 8px 12px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      display: flex;
      gap: 6px;
      align-items: center;
      z-index: 150;
    }
    .search-overlay input {
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      width: 150px;
    }
    .search-overlay button {
      padding: 4px 8px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 4px;
      cursor: pointer;
    }
    .search-overlay button:hover {
      background: #f5f5f5;
    }
    #searchCount {
      font-size: 12px;
      color: #666;
      min-width: 40px;
    }
    /* ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
    .search-highlight {
      background: #ffeb3b;
      padding: 1px 2px;
      border-radius: 2px;
    }
    .search-highlight.current {
      background: #ff9800;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="header-buttons">
        <button class="header-btn icon-btn" id="settingsBtn">âš™</button>
        <button class="header-btn" id="helpBtn">ä½¿ã„æ–¹</button>
      </div>
      <h1>ã‚†ã‚‹ã‚¹ã‚±</h1>
      <div class="header-buttons">
        <button class="header-btn icon-btn" id="calendarBtn">ğŸ“…</button>
        <a href="https://ko-fi.com/yurukusa" target="_blank" rel="noopener noreferrer" class="header-btn icon-btn support-icon">â˜•</a>
      </div>
    </header>

    <!-- ä½¿ã„æ–¹ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
    <div class="popup-overlay" id="helpPopup" style="display: none;">
      <div class="popup">
        <div class="popup-header">
          <span>ä½¿ã„æ–¹</span>
          <button class="popup-close" onclick="closePopup('helpPopup')">Ã—</button>
        </div>
        <div class="popup-content">
          <h3>ã€äºˆå®šã‚’è¿½åŠ ã™ã‚‹ã€‘</h3>
          æ—¥ä»˜ã¨æ™‚é–“ã¨å†…å®¹ã‚’å…¥åŠ›ã—ã¦ã­<br>
          <span class="example">ä¾‹ï¼š1/20 1400 ä¼šè­°</span><br>
          <span class="example">ä¾‹ï¼šæ˜æ—¥ 18æ™‚ é£²ã¿ä¼š</span>

          <h3>ã€äºˆå®šã‚’ç¢ºèªã™ã‚‹ã€‘</h3>
          ã€Œäºˆå®šã€ã¨å…¥åŠ›ã—ã¦ã­

          <h3>ã€äºˆå®šã‚’å‰Šé™¤ã™ã‚‹ã€‘</h3>
          æ—¥ä»˜ã¨å†…å®¹ã‚’å…¥åŠ›ã—ã¦ã€Œå‰Šé™¤ã€ã‚’ã¤ã‘ã¦ã­<br>
          <span class="example">ä¾‹ï¼š1/20ã®ä¼šè­°ã‚’å‰Šé™¤</span>

          <h3>ã€äºˆå®šã‚’å¤‰æ›´ã™ã‚‹ã€‘</h3>
          <span class="example">ä¾‹ï¼š1/20ã®ä¼šè­°ã‚’1500ã«å¤‰æ›´</span><br>
          <span class="example">ä¾‹ï¼š1/20ã®ä¼šè­°ã‚’1/21ã«å¤‰æ›´</span>

          <h3>ã€ä»–äººã®äºˆå®šã‚’è¿½åŠ ã™ã‚‹ã€‘</h3>
          ã‚«ãƒƒã‚³ã§å›²ã‚€ã‹ã€æœ€å¾Œã«ã€Œä»–äººã®äºˆå®šã€ã‚’ã¤ã‘ã¦ã­<br>
          <span class="example">ä¾‹ï¼š1/20 (1400 å­ä¾›ã®ç¿’ã„äº‹)</span><br>
          <span class="example">ä¾‹ï¼š1/20 1400 å­ä¾›ã®ç¿’ã„äº‹ ä»–äººã®äºˆå®š</span>

          <h3>ã€ç¹°ã‚Šè¿”ã—äºˆå®šã‚’è¿½åŠ ã™ã‚‹ã€‘</h3>
          ã€Œæ¯é€±ã€‡æ›œã€ã§è‡ªå‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ã‚ˆ<br>
          <span class="example">ä¾‹ï¼šæ¯é€±æœˆæ›œ 10æ™‚ å®šä¾‹ä¼šè­°</span><br>
          <span class="example">ä¾‹ï¼šæ¯é€±é‡‘æ›œ 18æ™‚ é£²ã¿ä¼š</span>

          <h3>ã€ä¾¿åˆ©æ©Ÿèƒ½ã€‘</h3>
          <span class="example">Ctrl+Zï¼šå…ƒã«æˆ»ã™</span><br>
          <span class="example">Ctrl+Fï¼šæ¤œç´¢ï¼ˆãƒã‚¤ãƒ©ã‚¤ãƒˆï¼‰</span><br>
          <span class="example">ğŸ“…ï¼šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º</span>
        </div>
      </div>
    </div>

    <!-- è¨­å®šãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
    <div class="popup-overlay" id="settingsPopup" style="display: none;">
      <div class="popup">
        <div class="popup-header">
          <span>è¨­å®š</span>
          <button class="popup-close" onclick="closePopup('settingsPopup')">Ã—</button>
        </div>
        <div class="popup-content">
          <div class="settings-item">
            <span>ğŸ”” ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼é€šçŸ¥</span>
            <label class="toggle-switch">
              <input type="checkbox" id="reminderToggle">
              <span class="toggle-slider"></span>
            </label>
          </div>
          <div class="settings-item" id="reminderMinutesRow" style="display: none;">
            <span>ã€€ä½•åˆ†å‰ã«é€šçŸ¥</span>
            <select id="reminderMinutesSelect">
              <option value="5">5åˆ†å‰</option>
              <option value="10">10åˆ†å‰</option>
              <option value="15">15åˆ†å‰</option>
              <option value="30">30åˆ†å‰</option>
              <option value="60">1æ™‚é–“å‰</option>
            </select>
          </div>
          <div class="settings-item">
            <span>ğŸ”„ ç¹°ã‚Šè¿”ã—äºˆå®šã®æœŸé–“</span>
            <select id="repeatEndMonthsSelect">
              <option value="1">ç¿Œæœˆæœ«ã¾ã§</option>
              <option value="2">2ãƒ¶æœˆå…ˆã¾ã§</option>
              <option value="3">3ãƒ¶æœˆå…ˆã¾ã§</option>
              <option value="6">åŠå¹´å…ˆã¾ã§</option>
            </select>
          </div>
          <div class="repeat-patterns-section">
            <div class="repeat-patterns-header">ğŸ“… ç™»éŒ²ä¸­ã®å®šæœŸäºˆå®š</div>
            <div id="repeatPatternsList" class="repeat-patterns-list">
              <div class="no-patterns">å®šæœŸäºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</div>
            </div>
            <button class="detect-patterns-btn" onclick="detectRepeatPatterns()">ğŸ” äºˆå®šã‹ã‚‰å®šæœŸãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡º</button>
            <div id="detectedPatternsList" class="detected-patterns-list" style="display: none;">
              <div class="detected-patterns-header">æ¤œå‡ºã•ã‚ŒãŸå®šæœŸãƒ‘ã‚¿ãƒ¼ãƒ³</div>
              <div id="detectedPatternsContent"></div>
            </div>
          </div>
          <div class="settings-item disabled">
            <span>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆé€£æº</span>
            <span class="badge">æº–å‚™ä¸­</span>
          </div>
          <div class="settings-item disabled">
            <span>Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é€£æº</span>
            <span class="badge">æº–å‚™ä¸­</span>
          </div>
          <div class="settings-item disabled">
            <span>è¨€èªè¨­å®š</span>
            <span class="badge">æº–å‚™ä¸­</span>
          </div>
          <button class="data-btn" id="exportBtn">ğŸ“¤ äºˆå®šã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
          <button class="data-btn" id="importBtn">ğŸ“¥ äºˆå®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
          <button class="data-btn" id="exportIcalBtn">ğŸ“… Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”¨ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
          <input type="file" id="importFile" accept=".json" style="display: none;">
          <a href="https://ko-fi.com/yurukusa" target="_blank" rel="noopener noreferrer" class="support-btn">â˜• é–‹ç™ºã‚’å¿œæ´ã™ã‚‹</a>
          <button class="delete-all-btn" id="deleteAllBtn">å…¨ã¦ã®äºˆå®šã‚’å‰Šé™¤</button>
        </div>
      </div>
    </div>

    <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
    <div class="popup-overlay" id="calendarPopup" style="display: none;">
      <div class="popup calendar-popup">
        <div class="popup-header">
          <span>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</span>
          <button class="popup-close" onclick="closePopup('calendarPopup')">Ã—</button>
        </div>
        <div class="popup-content calendar-content">
          <div class="calendar-nav">
            <button class="cal-nav-btn" onclick="changeCalendarMonth(-1)">â—€</button>
            <span id="calendarMonthLabel"></span>
            <button class="cal-nav-btn" onclick="changeCalendarMonth(1)">â–¶</button>
          </div>
          <div class="calendar-grid" id="calendarGrid"></div>
        </div>
      </div>
    </div>

    <!-- æ¤œç´¢ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div class="search-overlay" id="searchOverlay" style="display: none;">
      <input type="text" id="searchInput" placeholder="æ¤œç´¢...">
      <span id="searchCount"></span>
      <button onclick="searchPrev()">â–²</button>
      <button onclick="searchNext()">â–¼</button>
      <button onclick="closeSearch()">Ã—</button>
    </div>

    <div class="main-container">
      <div class="chat-section">
        <div class="messages" id="messages"></div>
        <form class="input-form" id="inputForm">
          <input type="text" id="inputField" placeholder="äºˆå®šã‚’å…¥åŠ›..." autocomplete="off">
          <button type="button" class="voice-btn" id="voiceBtn">ğŸ¤</button>
          <button type="submit">é€ä¿¡</button>
        </form>
      </div>
    </div>
  </div>

  <script>
    // çŠ¶æ…‹ç®¡ç†
    let schedules = JSON.parse(localStorage.getItem('schedules') || '[]');
    let repeatPatterns = JSON.parse(localStorage.getItem('repeatPatterns') || '[]'); // å®šæœŸäºˆå®šãƒ‘ã‚¿ãƒ¼ãƒ³
    let pendingAction = null; // { type: 'add'|'modify'|'delete', ... }
    let undoStack = []; // Undoç”¨ã®ã‚¹ã‚¿ãƒƒã‚¯
    const MAX_UNDO = 20;

    // è¨­å®šã®èª­ã¿è¾¼ã¿
    let appSettings = JSON.parse(localStorage.getItem('appSettings') || '{}');
    if (!appSettings.repeatEndMonths) appSettings.repeatEndMonths = 2; // ç¹°ã‚Šè¿”ã—äºˆå®šã®æœŸé–“ï¼ˆæœˆæ•°ï¼‰
    if (!appSettings.reminderMinutes) appSettings.reminderMinutes = 30; // ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ä½•åˆ†å‰
    if (!appSettings.reminderEnabled) appSettings.reminderEnabled = false;
    localStorage.setItem('appSettings', JSON.stringify(appSettings));

    // DOMè¦ç´ 
    const messagesEl = document.getElementById('messages');
    const inputForm = document.getElementById('inputForm');
    const inputField = document.getElementById('inputField');

    // ============================================
    // æ—¥ä»˜ãƒ»æ™‚é–“ãƒ‘ãƒ¼ã‚µãƒ¼ï¼ˆéƒ¨å“ã¨ã—ã¦ä½¿ç”¨ï¼‰
    // ============================================
    function parseDateFromText(input) {
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      let date = null;
      let consumed = '';

      const weekdayMap = { 'æ—¥': 0, 'æœˆ': 1, 'ç«': 2, 'æ°´': 3, 'æœ¨': 4, 'é‡‘': 5, 'åœŸ': 6 };

      // ä»Šæœˆæœ« / æ¥æœˆæœ« / å†æ¥æœˆæœ«
      const monthEndMatch = input.match(/(ä»Šæœˆ|æ¥æœˆ|å†æ¥æœˆ)æœ«/);
      if (monthEndMatch && !date) {
        date = new Date(today);
        if (monthEndMatch[1] === 'æ¥æœˆ') date.setMonth(date.getMonth() + 1);
        else if (monthEndMatch[1] === 'å†æ¥æœˆ') date.setMonth(date.getMonth() + 2);
        date = new Date(date.getFullYear(), date.getMonth() + 1, 0);
        consumed = monthEndMatch[0];
      }

      // ä»Šæœˆé ­ / æ¥æœˆé ­
      const monthStartMatch = input.match(/(ä»Šæœˆ|æ¥æœˆ|å†æ¥æœˆ)(é ­|åˆã‚?|ã‚ãŸã¾|ã¯ã˜ã‚)/);
      if (monthStartMatch && !date) {
        date = new Date(today);
        if (monthStartMatch[1] === 'ä»Šæœˆ' && today.getDate() > 5) date.setMonth(date.getMonth() + 1);
        else if (monthStartMatch[1] === 'æ¥æœˆ') date.setMonth(date.getMonth() + 1);
        else if (monthStartMatch[1] === 'å†æ¥æœˆ') date.setMonth(date.getMonth() + 2);
        date.setDate(1);
        consumed = monthStartMatch[0];
      }

      // æ¥é€±/ä»Šé€±/å†æ¥é€± + æ›œæ—¥
      const weekMatch = input.match(/(æ¥é€±|ä»Šé€±|å†æ¥é€±)ã®?([æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ])æ›œ?æ—¥?/);
      if (weekMatch && !date) {
        const weekOffset = weekMatch[1] === 'æ¥é€±' ? 1 : weekMatch[1] === 'å†æ¥é€±' ? 2 : 0;
        const targetDay = weekdayMap[weekMatch[2]];
        date = new Date(today);
        let daysToAdd = targetDay - date.getDay();
        if (daysToAdd <= 0 && weekOffset === 0) daysToAdd += 7;
        date.setDate(date.getDate() + daysToAdd + weekOffset * 7);
        consumed = weekMatch[0];
      }

      // ä»Šåº¦ã®/æ¬¡ã® + æ›œæ—¥
      const nextWeekdayMatch = input.match(/(ä»Šåº¦|æ¬¡)ã®?([æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ])æ›œ?æ—¥?/);
      if (nextWeekdayMatch && !date) {
        const targetDay = weekdayMap[nextWeekdayMatch[2]];
        date = new Date(today);
        let daysToAdd = targetDay - date.getDay();
        if (daysToAdd <= 0) daysToAdd += 7;
        date.setDate(date.getDate() + daysToAdd);
        consumed = nextWeekdayMatch[0];
      }

      // æ˜æ—¥/æ˜å¾Œæ—¥/ã‚ã•ã£ã¦/ã—ã‚ã•ã£ã¦/ä»Šæ—¥
      const dayPatterns = [
        { regex: /ã—ã‚ã•ã£ã¦/, days: 3 },
        { regex: /(æ˜å¾Œæ—¥|ã‚ã•ã£ã¦)/, days: 2 },
        { regex: /æ˜æ—¥/, days: 1 },
        { regex: /ä»Šæ—¥/, days: 0 },
      ];
      for (const { regex, days } of dayPatterns) {
        const match = input.match(regex);
        if (match && !date) {
          date = new Date(today);
          date.setDate(date.getDate() + days);
          consumed = match[0];
          break;
        }
      }

      // Xæ—¥å¾Œ / Xé€±é–“å¾Œ
      const daysLaterMatch = input.match(/(\d+)æ—¥å¾Œ/);
      if (daysLaterMatch && !date) {
        date = new Date(today);
        date.setDate(date.getDate() + parseInt(daysLaterMatch[1]));
        consumed = daysLaterMatch[0];
      }

      const weeksLaterMatch = input.match(/(\d+)é€±é–“?å¾Œ/);
      if (weeksLaterMatch && !date) {
        date = new Date(today);
        date.setDate(date.getDate() + parseInt(weeksLaterMatch[1]) * 7);
        consumed = weeksLaterMatch[0];
      }

      // MæœˆDæ—¥ ã¾ãŸã¯ M/D
      const dateMatch = input.match(/(\d{1,2})[\/æœˆ](\d{1,2})æ—¥?/);
      if (dateMatch && !date) {
        date = new Date(today.getFullYear(), parseInt(dateMatch[1]) - 1, parseInt(dateMatch[2]));
        if (date < today) date.setFullYear(date.getFullYear() + 1);
        consumed = dateMatch[0];
      }

      return date ? { date, consumed } : null;
    }

    function parseTimeFromText(input) {
      let time = null;
      let consumed = '';

      // æ™‚é–“ã®å¾Œã«ç¶šãåŠ©è©ï¼ˆã‹ã‚‰ã€ã‚ˆã‚Šã€ã«ã€ã¾ã§ç­‰ï¼‰ã‚‚å«ã‚ã¦æ¶ˆè²»ã™ã‚‹
      const timeSuffix = '(?:[\\sã€€]*(ã‹ã‚‰|ã‚ˆã‚Š|ã«|ã¾ã§|é ƒ))?';

      const timePatterns = [
        // åˆå‰/åˆå¾Œä»˜ãã®æ™‚é–“
        { regex: new RegExp(`(åˆå‰|åˆå¾Œ)[\\sã€€]*(\\d{1,2})[æ™‚:](\\d{2})åˆ†?${timeSuffix}`), handler: (m) => {
          let h = parseInt(m[2]);
          if (m[1] === 'åˆå¾Œ' && h < 12) h += 12;
          if (m[1] === 'åˆå‰' && h === 12) h = 0;
          return { h, m: parseInt(m[3]) };
        }},
        { regex: new RegExp(`(åˆå‰|åˆå¾Œ)[\\sã€€]*(\\d{1,2})æ™‚åŠ${timeSuffix}`), handler: (m) => {
          let h = parseInt(m[2]);
          if (m[1] === 'åˆå¾Œ' && h < 12) h += 12;
          if (m[1] === 'åˆå‰' && h === 12) h = 0;
          return { h, m: 30 };
        }},
        { regex: new RegExp(`(åˆå‰|åˆå¾Œ)[\\sã€€]*(\\d{1,2})æ™‚${timeSuffix}`), handler: (m) => {
          let h = parseInt(m[2]);
          if (m[1] === 'åˆå¾Œ' && h < 12) h += 12;
          if (m[1] === 'åˆå‰' && h === 12) h = 0;
          return { h, m: 0 };
        }},
        // é€šå¸¸ã®æ™‚é–“è¡¨è¨˜ï¼ˆåŠ©è©ä»˜ãï¼‰
        { regex: new RegExp(`(\\d{1,2})[æ™‚:](\\d{2})åˆ†?${timeSuffix}`), handler: (m) => ({ h: parseInt(m[1]), m: parseInt(m[2]) }) },
        { regex: new RegExp(`(\\d{1,2})æ™‚åŠ${timeSuffix}`), handler: (m) => ({ h: parseInt(m[1]), m: 30 }) },
        { regex: new RegExp(`(\\d{1,2})æ™‚${timeSuffix}`), handler: (m) => ({ h: parseInt(m[1]), m: 0 }) },
        // 4æ¡/3æ¡æ™‚é–“
        { regex: /(?<![\/\d])(\d{3,4})[\sã€€]*(ã‹ã‚‰|ã‚ˆã‚Š|ã«)?(?!\d|æ—¥|å¹´|æœˆ)/, handler: (m) => {
          const t = m[1].padStart(4, '0');
          const h = parseInt(t.slice(0, 2));
          const min = parseInt(t.slice(2));
          if (h >= 0 && h <= 23 && min >= 0 && min <= 59) return { h, m: min };
          return null;
        }},
      ];

      for (const { regex, handler } of timePatterns) {
        const match = input.match(regex);
        if (match) {
          const result = handler(match);
          if (result) {
            time = result;
            consumed = match[0];
            break;
          }
        }
      }

      if (!time) {
        const vagueTimePatterns = [
          { regex: /æ—©æœ/, hour: 6 },
          { regex: /æœ/, hour: 9 },
          { regex: /åˆå‰ä¸­?/, hour: 10 },
          { regex: /ãŠæ˜¼|æ˜¼/, hour: 12 },
          { regex: /åˆå¾Œ/, hour: 14 },
          { regex: /å¤•æ–¹|å¤•/, hour: 17 },
          { regex: /å¤œ|æ™©|å¤œé–“/, hour: 19 },
          { regex: /æ·±å¤œ/, hour: 23 },
        ];
        for (const { regex, hour } of vagueTimePatterns) {
          const match = input.match(regex);
          if (match) {
            time = { h: hour, m: 0 };
            consumed = match[0];
            break;
          }
        }
      }

      return time ? { time, consumed } : null;
    }

    function formatTime(time) {
      return time ? `${String(time.h).padStart(2, '0')}${String(time.m).padStart(2, '0')}` : null;
    }

    // ============================================
    // äºˆå®šè¿½åŠ ãƒ‘ãƒ¼ã‚µãƒ¼
    // ============================================
    function parseScheduleInput(input) {
      let title = input;

      // ã‚«ãƒƒã‚³ä»˜ãã®äºˆå®šã‚’æ¤œå‡ºï¼ˆä¾‹ï¼š12/14 (0800 ãƒ‰ãƒªãƒ•)ã€1/17 (1000 ã‚Œã„ãªä¸€æ™‚ä¿è‚²)ï¼‰
      const parenMatch = input.match(/^(.+?)\s*[ï¼ˆ(](\d{3,4})\s+(.+?)[)ï¼‰]$/);
      if (parenMatch) {
        const dateStr = parenMatch[1].trim();
        const timeStr = parenMatch[2].padStart(4, '0');
        const titleInParen = parenMatch[3].trim();

        const h = parseInt(timeStr.slice(0, 2));
        const m = parseInt(timeStr.slice(2));
        if (h >= 0 && h <= 23 && m >= 0 && m <= 59) {
          const dateResult = parseDateFromText(dateStr);
          if (dateResult) {
            const result = {
              date: `${dateResult.date.getMonth() + 1}/${dateResult.date.getDate()}`,
              time: timeStr,
              title: titleInParen,
              fullDate: dateResult.date.toISOString(),
              isOther: true
            };
            return result;
          }
        }
      }

      // æ™‚é–“ãŒã‚«ãƒƒã‚³å¤–ã€ã‚¿ã‚¤ãƒˆãƒ«ã®ã¿ã‚«ãƒƒã‚³å†…ï¼ˆä¾‹ï¼š12/14 0800 (ãƒ‰ãƒªãƒ•)ï¼‰
      const timeOutsideParenMatch = input.match(/^(.+?)\s+(\d{3,4})\s*[ï¼ˆ(](.+?)[)ï¼‰]$/);
      if (timeOutsideParenMatch) {
        const dateStr = timeOutsideParenMatch[1].trim();
        const timeStr = timeOutsideParenMatch[2].padStart(4, '0');
        const titleInParen = timeOutsideParenMatch[3].trim();

        const h = parseInt(timeStr.slice(0, 2));
        const m = parseInt(timeStr.slice(2));
        if (h >= 0 && h <= 23 && m >= 0 && m <= 59) {
          const dateResult = parseDateFromText(dateStr);
          if (dateResult) {
            const result = {
              date: `${dateResult.date.getMonth() + 1}/${dateResult.date.getDate()}`,
              time: timeStr,
              title: titleInParen,
              fullDate: dateResult.date.toISOString(),
              isOther: true
            };
            return result;
          }
        }
      }

      // å…ˆé ­ã«ç„¡é–¢ä¿‚ãªæ–‡å­—ãŒã‚ã‚‹å ´åˆã€æ—¥ä»˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ä½ç½®ã‚’æ¢ã™
      const datePatternForSearch = /(\d{1,2}[\/æœˆ]\d{1,2}æ—¥?|(?:ä»Šæ—¥|æ˜æ—¥|æ˜å¾Œæ—¥|ã‚ã•ã£ã¦|ã—ã‚ã•ã£ã¦)|(?:æ¥é€±|ä»Šé€±|å†æ¥é€±)ã®?[æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ]æ›œ?æ—¥?|(?:ä»Šåº¦|æ¬¡)ã®?[æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ]æ›œ?æ—¥?|\d+æ—¥å¾Œ|\d+é€±é–“?å¾Œ|(?:ä»Šæœˆ|æ¥æœˆ|å†æ¥æœˆ)(?:æœ«|é ­|åˆã‚?|ã‚ãŸã¾|ã¯ã˜ã‚))/;
      const dateMatch = input.match(datePatternForSearch);

      let inputForParse = input;
      let prefixRemoved = '';
      if (dateMatch && dateMatch.index > 0) {
        // æ—¥ä»˜ã®å‰ã«ã‚ã‚‹æ–‡å­—ã‚’é™¤å»
        prefixRemoved = input.slice(0, dateMatch.index);
        inputForParse = input.slice(dateMatch.index);
      }

      const dateResult = parseDateFromText(inputForParse);
      if (!dateResult) return null;

      title = inputForParse.replace(dateResult.consumed, '').trim();

      const timeResult = parseTimeFromText(title);
      if (timeResult) {
        title = title.replace(timeResult.consumed, '').trim();
      }

      // ã€Œæœªå®šã€ã‚’æ™‚é–“ã¨ã—ã¦èªè­˜ã—ã€ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰é™¤å»
      let isTimeUndefined = false;
      if (!timeResult) {
        const undefinedTimeMatch = title.match(/^(æœªå®š|æ™‚é–“æœªå®š)\s*/);
        if (undefinedTimeMatch) {
          isTimeUndefined = true;
          title = title.replace(undefinedTimeMatch[0], '').trim();
        }
      }

      // æœ«å°¾ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‹•è©ã‚’é™¤å»ï¼ˆã€Œã‚’å…¥ã‚Œã¦ã€ã€Œã‚’è¿½åŠ ã€ã€Œã‚’ç™»éŒ²ã€ãªã©ï¼‰
      title = title.replace(/ã‚’?(å…¥ã‚Œ(ã¦|ã‚‹)?|è¿½åŠ (ã—ã¦|ã™ã‚‹)?|ç™»éŒ²(ã—ã¦|ã™ã‚‹)?|äºˆå®š(ã—ã¦|ã™ã‚‹)?|è¨­å®š(ã—ã¦|ã™ã‚‹)?)$/, '').trim();

      // ã‚¿ã‚¤ãƒˆãƒ«ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
      title = title
        .replace(/^[ã€,ã®ã«ã¯ã¸ã¨]\s*/, '')
        .replace(/\s*[ã€,ã®ã«ã¯ã¸ã¨]$/, '')
        .replace(/[ã€,]/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();

      // æœ«å°¾ã«ã€Œä»–äººã®äºˆå®šã€ã€Œå®¶æ—ã®äºˆå®šã€ãŒã‚ã‚Œã°isOther: true
      let isOther = false;
      const otherMatch = title.match(/[\sã€€]*(ä»–äººã®äºˆå®š|å®¶æ—ã®äºˆå®š)$/);
      if (otherMatch) {
        isOther = true;
        title = title.replace(otherMatch[0], '').trim();
      }

      return {
        date: `${dateResult.date.getMonth() + 1}/${dateResult.date.getDate()}`,
        time: timeResult ? formatTime(timeResult.time) : 'æœªå®š',
        title: title || 'äºˆå®š',
        fullDate: dateResult.date.toISOString(),
        isOther: isOther
      };
    }

    // ============================================
    // è¤‡æ•°äºˆå®šãƒ‘ãƒ¼ã‚µãƒ¼
    // ============================================
    // æ—¥ä»˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ­£è¦è¡¨ç¾ï¼ˆåˆ†å‰²ç”¨ï¼‰
    const datePatternRegex = /(\d{1,2}[\/æœˆ]\d{1,2}æ—¥?|(?:ä»Šæ—¥|æ˜æ—¥|æ˜å¾Œæ—¥|ã‚ã•ã£ã¦|ã—ã‚ã•ã£ã¦)|(?:æ¥é€±|ä»Šé€±|å†æ¥é€±)ã®?[æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ]æ›œ?æ—¥?|(?:ä»Šåº¦|æ¬¡)ã®?[æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ]æ›œ?æ—¥?|\d+æ—¥å¾Œ|\d+é€±é–“?å¾Œ|(?:ä»Šæœˆ|æ¥æœˆ|å†æ¥æœˆ)(?:æœ«|é ­|åˆã‚?|ã‚ãŸã¾|ã¯ã˜ã‚))/g;

    // ç„¡åŠ¹ãªã‚¿ã‚¤ãƒˆãƒ«ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
    function isInvalidTitle(title) {
      if (!title) return true;
      // ã€Œäºˆå®šã€ã®ã¿ã€ã¾ãŸã¯1-3æ¡ã®æ•°å­—ã®ã¿ã¯ç„¡åŠ¹
      if (title === 'äºˆå®š') return true;
      if (/^\d{1,3}$/.test(title)) return true;
      return false;
    }

    function parseMultipleSchedules(input) {
      // å…ˆé ­ã®ã€Œäºˆå®šï¼ã€ã€Œäºˆå®š! ã€ãªã©ã‚’é™¤å»
      let workInput = input.replace(/^äºˆå®š[ï¼!]?\s*/, '');

      // å…ˆé ­ã®ç„¡é–¢ä¿‚ãªæ–‡å­—ã‚’é™¤å»ï¼ˆæ—¥ä»˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¢ã™ï¼‰
      const firstDateMatch = workInput.match(datePatternRegex);
      if (!firstDateMatch) return null;

      if (firstDateMatch.index > 0) {
        workInput = workInput.slice(firstDateMatch.index);
      }

      // ã‚«ãƒƒã‚³ä»˜ãäºˆå®šã‚’å…ˆã«æŠ½å‡ºï¼ˆã‚«ãƒƒã‚³å†…ã‚’ä¿è­·ï¼‰
      // ã€Œ(1000 ã‚Œã„ãª)ã€ã€Œ(1000ã‚Œã„ãª)ã€ä¸¡æ–¹ã«å¯¾å¿œ
      const parenSchedules = [];
      const parenRanges = []; // ã‚«ãƒƒã‚³ã®ç¯„å›²ã‚’è¨˜éŒ²
      const fullParenRegex = /[ï¼ˆ(](\d{3,4})\s*(.+?)[)ï¼‰]/g;
      let parenMatch;
      while ((parenMatch = fullParenRegex.exec(workInput)) !== null) {
        const timeStr = parenMatch[1].padStart(4, '0');
        const h = parseInt(timeStr.slice(0, 2));
        const m = parseInt(timeStr.slice(2));
        if (h >= 0 && h <= 23 && m >= 0 && m <= 59) {
          parenSchedules.push({
            index: parenMatch.index,
            endIndex: parenMatch.index + parenMatch[0].length,
            time: timeStr,
            title: parenMatch[2].trim(),
            isOther: true
          });
          parenRanges.push({ start: parenMatch.index, end: parenMatch.index + parenMatch[0].length });
        }
      }

      // ã‚«ãƒƒã‚³ç¯„å›²å†…ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹é–¢æ•°
      function isInsideParen(index) {
        return parenRanges.some(r => index > r.start && index < r.end);
      }

      // åŒºåˆ‡ã‚Šãƒ‘ã‚¿ãƒ¼ãƒ³ã®ä½ç½®ã‚’æ¤œå‡º
      const allMatches = [];

      // æ—¥ä»˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡ºï¼ˆã‚«ãƒƒã‚³å†…ã¯é™¤å¤–ï¼‰
      const dateMatches = [...workInput.matchAll(datePatternRegex)];
      dateMatches.forEach(m => {
        if (!isInsideParen(m.index)) {
          allMatches.push({ index: m.index, type: 'date', match: m[0] });
        }
      });

      // ã‚«ãƒƒã‚³ä»˜ãäºˆå®šã®é–‹å§‹ä½ç½®ã‚’è¿½åŠ 
      parenSchedules.forEach(ps => {
        allMatches.push({ index: ps.index, type: 'paren', parenData: ps });
      });

      // æ™‚é–“ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆç©ºç™½å¾Œã®4æ¡æ•°å­—ï¼‰ã‚’æ¤œå‡ºï¼ˆã‚«ãƒƒã‚³å†…ã¯é™¤å¤–ï¼‰
      const timeRegex = /\s(\d{4})(?=\s|$|\D)/g;
      let match;
      while ((match = timeRegex.exec(workInput)) !== null) {
        const timeIndex = match.index + 1;
        if (isInsideParen(timeIndex)) continue;

        const timeStr = match[1];
        const h = parseInt(timeStr.slice(0, 2));
        const m = parseInt(timeStr.slice(2));
        if (h >= 0 && h <= 23 && m >= 0 && m <= 59) {
          // æ—¥ä»˜ã®ç›´å¾Œã§ã¯ãªã„æ™‚é–“ã®ã¿
          const isAfterDate = dateMatches.some(dm => {
            const dmEnd = dm.index + dm[0].length;
            return timeIndex > dmEnd && timeIndex <= dmEnd + 2;
          });
          if (!isAfterDate) {
            allMatches.push({ index: timeIndex, type: 'time', match: timeStr });
          }
        }
      }

      // ã€Œæœªå®šã€ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡ºï¼ˆã‚«ãƒƒã‚³å†…ã¯é™¤å¤–ï¼‰
      const undefinedTimeRegex = /\s(æœªå®š|æ™‚é–“æœªå®š)(?=\s|$)/g;
      while ((match = undefinedTimeRegex.exec(workInput)) !== null) {
        const undefinedIndex = match.index + 1;
        if (isInsideParen(undefinedIndex)) continue;

        // æ—¥ä»˜ã®ç›´å¾Œã§ã¯ãªã„ã€Œæœªå®šã€ã®ã¿
        const isAfterDate = dateMatches.some(dm => {
          const dmEnd = dm.index + dm[0].length;
          return undefinedIndex > dmEnd && undefinedIndex <= dmEnd + 2;
        });
        if (!isAfterDate) {
          allMatches.push({ index: undefinedIndex, type: 'undefined-time', match: match[1] });
        }
      }

      // ã‚½ãƒ¼ãƒˆã—ã¦é‡è¤‡ã‚’é™¤å»
      allMatches.sort((a, b) => a.index - b.index);

      if (allMatches.length <= 1) {
        return null;
      }

      // å„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ãƒ‘ãƒ¼ã‚¹
      const parsed = [];
      const skipped = []; // ã‚¹ã‚­ãƒƒãƒ—ã•ã‚ŒãŸäºˆå®šã‚’è¨˜éŒ²
      let lastDate = null;
      let lastFullDate = null;

      for (let i = 0; i < allMatches.length; i++) {
        const start = allMatches[i].index;
        const end = i < allMatches.length - 1 ? allMatches[i + 1].index : workInput.length;
        let segment = workInput.slice(start, end).trim();
        const matchType = allMatches[i].type;

        if (!segment) continue;

        // ã€Œ1/14 1900 (é£²ã¿ä¼š)ã€ã€Œ1/14 1900(é£²ã¿ä¼š)ã€ã€Œ1/14 1900( é£²ã¿ä¼š)ã€ã®ã‚ˆã†ãªå½¢å¼ã‚’å‡¦ç†
        // æ™‚é–“ã¨ã‚«ãƒƒã‚³ã®é–“ã®ã‚¹ãƒšãƒ¼ã‚¹ã¯ä»»æ„ã€ã‚«ãƒƒã‚³å†…ã®ã‚¿ã‚¤ãƒˆãƒ«å‰ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚‚ä»»æ„
        const timeParenMatch = segment.match(/^(\d{1,2}[\/æœˆ]\d{1,2}æ—¥?)\s+(\d{4})\s*[ï¼ˆ(]\s*(.+?)[)ï¼‰]$/);
        if (timeParenMatch) {
          const dateResult = parseDateFromText(timeParenMatch[1]);
          if (dateResult) {
            const title = timeParenMatch[3].trim();
            lastDate = `${dateResult.date.getMonth() + 1}/${dateResult.date.getDate()}`;
            lastFullDate = dateResult.date.toISOString();
            if (!isInvalidTitle(title)) {
              parsed.push({
                date: lastDate,
                time: timeParenMatch[2],
                title: title,
                fullDate: lastFullDate,
                isOther: true
              });
            } else {
              skipped.push(`${lastDate} ${timeParenMatch[2]} ${title || '(ç©º)'}`);
            }
            continue;
          }
        }

        // ã‚«ãƒƒã‚³ä»˜ãäºˆå®šï¼ˆä»–äººã®äºˆå®šï¼‰- äº‹å‰ã«æŠ½å‡ºã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
        if (matchType === 'paren') {
          const parenData = allMatches[i].parenData;
          if (parenData && lastDate) {
            if (!isInvalidTitle(parenData.title)) {
              parsed.push({
                date: lastDate,
                time: parenData.time,
                title: parenData.title,
                fullDate: lastFullDate,
                isOther: true
              });
            } else {
              skipped.push(`${lastDate} (${parenData.time} ${parenData.title || '(ç©º)'})`);
            }
          }
          continue;
        }

        // é€šå¸¸ã®æ—¥ä»˜ä»˜ãäºˆå®š
        if (matchType === 'date') {
          const schedule = parseScheduleInput(segment);
          if (schedule) {
            lastDate = schedule.date;
            lastFullDate = schedule.fullDate;
            if (!isInvalidTitle(schedule.title)) {
              parsed.push(schedule);
            } else {
              // æ¬¡ã®ãƒãƒƒãƒãŒã‚«ãƒƒã‚³ä»˜ãäºˆå®šã®å ´åˆã¯ã€æ—¥ä»˜ã®ã¿ã‚’è¨˜éŒ²ã—ã¦è­¦å‘Šã‚’å‡ºã•ãªã„
              const nextMatch = i < allMatches.length - 1 ? allMatches[i + 1] : null;
              const nextIsParen = nextMatch && nextMatch.type === 'paren';
              if (!nextIsParen) {
                const timeStr = schedule.time && schedule.time !== 'æœªå®š' ? ` ${schedule.time}` : '';
                skipped.push(`${schedule.date}${timeStr} ${schedule.title || '(ç©º)'}`);
              }
            }
          }
          continue;
        }

        // æ™‚é–“ã®ã¿ï¼ˆæ—¥ä»˜ã‚’å¼•ãç¶™ãï¼‰
        if (matchType === 'time' && lastDate) {
          const timeResult = parseTimeFromText(segment);
          if (timeResult) {
            let title = segment.replace(timeResult.consumed, '').trim();
            title = title.replace(/^[ã€,ã®ã«ã¯ã¸ã¨]\s*/, '').replace(/\s*[ã€,ã®ã«ã¯ã¸ã¨]$/, '').trim();

            // ã‚«ãƒƒã‚³ä»˜ãã‚¿ã‚¤ãƒˆãƒ«ã‚’æ¤œå‡ºï¼ˆä¾‹ï¼šã€Œ(é£²ã¿ä¼š)ã€ã€Œï¼ˆé£²ã¿ä¼šï¼‰ã€ï¼‰
            let isOtherSchedule = false;
            const parenTitleMatch = title.match(/^[ï¼ˆ(]\s*(.+?)\s*[)ï¼‰]$/);
            if (parenTitleMatch) {
              title = parenTitleMatch[1];
              isOtherSchedule = true;
            }

            if (!isInvalidTitle(title)) {
              parsed.push({
                date: lastDate,
                time: formatTime(timeResult.time),
                title: title,
                fullDate: lastFullDate,
                isOther: isOtherSchedule
              });
            } else {
              skipped.push(`${lastDate} ${formatTime(timeResult.time)} ${title || '(ç©º)'}`);
            }
          }
        }

        // æœªå®šæ™‚é–“ï¼ˆæ—¥ä»˜ã‚’å¼•ãç¶™ãï¼‰
        if (matchType === 'undefined-time' && lastDate) {
          // ã€Œæœªå®šã€ã¾ãŸã¯ã€Œæ™‚é–“æœªå®šã€ã‚’é™¤å»ã—ã¦ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—
          let title = segment.replace(/^(æœªå®š|æ™‚é–“æœªå®š)\s*/, '').trim();
          title = title.replace(/^[ã€,ã®ã«ã¯ã¸ã¨]\s*/, '').replace(/\s*[ã€,ã®ã«ã¯ã¸ã¨]$/, '').trim();

          if (!isInvalidTitle(title)) {
            parsed.push({
              date: lastDate,
              time: 'æœªå®š',
              title: title,
              fullDate: lastFullDate,
              isOther: false
            });
          } else {
            skipped.push(`${lastDate} æœªå®š ${title || '(ç©º)'}`);
          }
        }
      }

      if (parsed.length > 1) {
        return { schedules: parsed, skipped: skipped };
      }
      return null;
    }

    // ============================================
    // äºˆå®šæ¤œç´¢
    // ============================================
    function findSchedule(dateStr, timeStr, keyword) {
      // æ—¥ä»˜ãƒ»æ™‚é–“ãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§äºˆå®šã‚’æ¤œç´¢
      const matches = schedules.filter(s => {
        const dateMatch = !dateStr || s.date === dateStr;
        const timeMatch = !timeStr || s.time === timeStr;
        const keywordMatch = !keyword || s.title.includes(keyword);
        return dateMatch && timeMatch && keywordMatch;
      });
      return matches;
    }

    // ============================================
    // ä¸€æ‹¬å‰Šé™¤ãƒ‘ãƒ¼ã‚µãƒ¼
    // ============================================
    function parseBulkDelete(input) {
      // æœ«å°¾ã«å‰Šé™¤ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      const deleteKeywords = /(ã‚’?å‰Šé™¤|ã‚’?æ¶ˆã—ã¦|ã‚’?æ¶ˆã™)$/;
      if (!deleteKeywords.test(input)) return null;

      const content = input.replace(deleteKeywords, '').trim();

      // æ”¹è¡Œã¾ãŸã¯ã‚¹ãƒšãƒ¼ã‚¹ã§æ—¥ä»˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¢ã™
      // æ—¥ä»˜ãƒ‘ã‚¿ãƒ¼ãƒ³: 1/26, 2/2 ãªã©
      const dateRegex = /(\d{1,2}\/\d{1,2})/g;
      const dates = content.match(dateRegex);

      // 2ã¤ä»¥ä¸Šã®æ—¥ä»˜ãŒãªã„ã¨ä¸€æ‹¬å‰Šé™¤ã§ã¯ãªã„
      if (!dates || dates.length < 2) return null;

      // æ—¥ä»˜ã§åˆ†å‰²ã—ã¦å„ã‚¨ãƒ³ãƒˆãƒªã‚’ãƒ‘ãƒ¼ã‚¹
      const segments = content.split(/(?=\d{1,2}\/\d{1,2})/);
      const matches = [];
      const seen = new Set();

      segments.forEach(segment => {
        const trimmed = segment.trim();
        if (!trimmed) return;

        // æ—¥ä»˜+æ™‚é–“+ã‚¿ã‚¤ãƒˆãƒ« ã¾ãŸã¯ æ—¥ä»˜+ã‚¿ã‚¤ãƒˆãƒ« ã‚’æ¤œå‡º
        const entryMatch = trimmed.match(/^(\d{1,2}\/\d{1,2})\s+(\d{4})?\s*(.*)$/);
        if (entryMatch) {
          const date = entryMatch[1];
          const time = entryMatch[2] || null;
          let title = entryMatch[3]?.trim() || null;

          // ã‚¿ã‚¤ãƒˆãƒ«ã®æœ«å°¾ã®ä½™åˆ†ãªã‚¹ãƒšãƒ¼ã‚¹ã‚„æ¬¡ã®ã‚¨ãƒ³ãƒˆãƒªã®ä¸€éƒ¨ã‚’é™¤å»
          if (title) {
            title = title.replace(/\s+$/, '');
          }

          // ãƒãƒƒãƒã™ã‚‹äºˆå®šã‚’æ¤œç´¢
          schedules.forEach(s => {
            const dateMatch = s.date === date;
            const timeMatch = !time || s.time === time;
            const titleMatch = !title || s.title === title || s.title.includes(title) || title.includes(s.title);

            if (dateMatch && timeMatch && titleMatch) {
              const key = `${s.date}-${s.time}-${s.title}`;
              if (!seen.has(key)) {
                seen.add(key);
                matches.push(s);
              }
            }
          });
        }
      });

      return matches.length >= 2 ? { matches } : null;
    }

    // ============================================
    // å¤‰æ›´ãƒ»å‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ‘ãƒ¼ã‚µãƒ¼
    // ============================================
    function parseModificationRequest(input) {
      // å¤‰æ›´ãƒ‘ã‚¿ãƒ¼ãƒ³1: ã€Œã€œã‚’ã€œã«å¤‰æ›´ã€ã€Œã€œã‚’ã€œã«ã—ã¦ã€ã€Œã€œã‚’ã€œã«ä¿®æ­£ã€ã€Œã€œã‚’ã€œã«å¤‰ãˆã¦ã€
      // ã€Œã‚’ã€ã‚’åŒºåˆ‡ã‚Šã¨ã—ã¦ä½¿ç”¨ï¼ˆã€Œã®ã€ã¯å¯¾è±¡ã®ä¸€éƒ¨ã¨ã—ã¦æ‰±ã†ï¼š1æœˆ12æ—¥ã®ä¼šè­° ãªã©ï¼‰
      const modifyMatch1 = input.match(/(.+)ã‚’(.+?)[ã«ã¸](å¤‰æ›´|ã—ã¦|ã™ã‚‹|ç§»å‹•|å¤‰ãˆã¦|å¤‰ãˆã‚‹|ä¿®æ­£|ç›´ã—ã¦|ç›´ã™|è¨‚æ­£)/);
      if (modifyMatch1) {
        const target = modifyMatch1[1];
        const newValue = modifyMatch1[2];
        return parseTargetAndAction(target, 'modify', newValue);
      }

      // å¤‰æ›´ãƒ‘ã‚¿ãƒ¼ãƒ³2: ã€Œã€œ æ—¥ä»˜ æ™‚é–“ã«å¤‰æ›´ã€ã€Œã€œ æ™‚é–“ã«å¤‰æ›´ã€ã€Œã€œ æ—¥ä»˜ã«å¤‰æ›´ã€
      // åŒºåˆ‡ã‚Šæ–‡å­—: ã‚¹ãƒšãƒ¼ã‚¹ã€ã€Œã¯ã€ã€Œã‚’ã€ã€Œã€ã€
      const modifyEndMatch = input.match(/[ã«ã¸](å¤‰æ›´|å¤‰ãˆã¦|å¤‰ãˆã‚‹|ç§»å‹•|ã—ã¦|ã™ã‚‹|ä¿®æ­£|ç›´ã—ã¦|ç›´ã™|è¨‚æ­£)$/);
      if (modifyEndMatch) {
        const beforeEnd = input.slice(0, modifyEndMatch.index).trim();

        // åŒºåˆ‡ã‚Šæ–‡å­—ãƒ‘ã‚¿ãƒ¼ãƒ³: ã‚¹ãƒšãƒ¼ã‚¹ã€ã¯ã€ã‚’ã€ã€
        const sep = '[\\sã€€ã¯ã‚’ã€]+';

        // ãƒ‘ã‚¿ãƒ¼ãƒ³1: æ—¥ä»˜+æ™‚é–“ï¼ˆä¾‹: 2/15 18æ™‚ã€2/15 1800ã€æ¥é€±ã®æœˆæ›œ 15æ™‚ï¼‰
        const dateTimeRegex = new RegExp(`^(.+?)${sep}((?:\\d{1,2}\\/\\d{1,2}|ä»Šæ—¥|æ˜æ—¥|æ˜å¾Œæ—¥|ã‚ã•ã£ã¦|æ¥é€±.+?æ›œæ—¥?)[\\sã€€]*(?:\\d{1,2}æ™‚åŠ?|\\d{3,4}))$`);
        const dateTimeMatch = beforeEnd.match(dateTimeRegex);
        if (dateTimeMatch) {
          const targetPart = dateTimeMatch[1].trim();
          const newValuePart = dateTimeMatch[2].trim();
          return parseTargetAndAction(targetPart, 'modify', newValuePart);
        }

        // ãƒ‘ã‚¿ãƒ¼ãƒ³2: æ™‚é–“ã®ã¿ï¼ˆä¾‹: 18æ™‚ã€1800ã€åˆå¾Œ3æ™‚ã€15æ™‚ã‹ã‚‰ï¼‰
        const timeRegex = new RegExp(`^(.+?)${sep}((?:åˆå‰|åˆå¾Œ)?\\d{1,2}æ™‚åŠ?(?:ã‹ã‚‰)?|\\d{3,4})$`);
        const timeExprMatch = beforeEnd.match(timeRegex);
        if (timeExprMatch) {
          const targetPart = timeExprMatch[1].trim();
          const newValuePart = timeExprMatch[2].trim();
          const hasTime = parseTimeFromText(newValuePart);
          if (hasTime) {
            return parseTargetAndAction(targetPart, 'modify', newValuePart);
          }
        }

        // ãƒ‘ã‚¿ãƒ¼ãƒ³3: æ—¥ä»˜ã®ã¿ï¼ˆä¾‹: 2/15ã€æ¥é€±ã®æœˆæ›œã€æ˜æ—¥ï¼‰
        const dateRegex = new RegExp(`^(.+?)${sep}(\\d{1,2}\\/\\d{1,2}|ä»Šæ—¥|æ˜æ—¥|æ˜å¾Œæ—¥|ã‚ã•ã£ã¦|æ¥é€±ã®?[æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ]æ›œæ—¥?)$`);
        const dateExprMatch = beforeEnd.match(dateRegex);
        if (dateExprMatch) {
          const targetPart = dateExprMatch[1].trim();
          const newValuePart = dateExprMatch[2].trim();
          const hasDate = parseDateFromText(newValuePart);
          if (hasDate) {
            return parseTargetAndAction(targetPart, 'modify', newValuePart);
          }
        }
      }

      // ç›¸å¯¾æ™‚é–“å¤‰æ›´ãƒ‘ã‚¿ãƒ¼ãƒ³: ã€Œã€œã‚’2æ™‚é–“é…ã‚‰ã›ã¦ã€ã€Œã€œã‚’1æ™‚é–“æ—©ã‚ã¦ã€ã€Œã€œã‚’30åˆ†å¾Œã«ã—ã¦ã€
      const relativeTimeMatch = input.match(/(.+?)ã‚’(\d+)(æ™‚é–“|åˆ†)(é…ã‚‰ã›|æ—©ã‚|å¾Œã«|å‰ã«)(ã¦|ã‚‹)?$/);
      if (relativeTimeMatch) {
        const target = relativeTimeMatch[1].trim();
        const amount = parseInt(relativeTimeMatch[2]);
        const unit = relativeTimeMatch[3]; // æ™‚é–“ or åˆ†
        const direction = relativeTimeMatch[4]; // é…ã‚‰ã›/å¾Œã« or æ—©ã‚/å‰ã«
        const isLater = direction === 'é…ã‚‰ã›' || direction === 'å¾Œã«';
        return parseTargetAndRelativeTime(target, amount, unit, isLater);
      }

      // å‰Šé™¤ãƒ‘ã‚¿ãƒ¼ãƒ³: æœ«å°¾ã«å‰Šé™¤ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒã‚ã‚‹å ´åˆ
      const deleteKeywords = /(ã‚’?(å‰Šé™¤|æ¶ˆã—ã¦|æ¶ˆã™)|ãªããªã£ãŸ|ç„¡ããªã£ãŸ|ã‚­ãƒ£ãƒ³ã‚»ãƒ«(ã—ã¦|ã™ã‚‹)?|å–ã‚Š?æ¶ˆã—(ã¦|ãŸ)?|ä¸­æ­¢(ã—ã¦|ã™ã‚‹)?|ã‚„ã‚(ã¦|ãŸ|ã‚‹)?|é–“é•ã„(ã ã£ãŸ)?|ãªããªã‚‹|ç„¡ããªã‚‹|ãªã—|ãƒŠã‚·|ã‚„ã‚‰ãªã„)$/;
      const deleteMatch = input.match(deleteKeywords);
      if (deleteMatch) {
        const target = input.replace(deleteKeywords, '').trim();
        return parseTargetAndAction(target, 'delete', null);
      }

      return null;
    }

    // ç›¸å¯¾æ™‚é–“å¤‰æ›´ã®ãƒ‘ãƒ¼ã‚µãƒ¼
    function parseTargetAndRelativeTime(targetStr, amount, unit, isLater) {
      // å¯¾è±¡ã‚’ç‰¹å®š
      let targetDate = null;
      let targetTime = null;
      let keyword = targetStr;

      const dateResult = parseDateFromText(targetStr);
      if (dateResult) {
        targetDate = `${dateResult.date.getMonth() + 1}/${dateResult.date.getDate()}`;
        keyword = targetStr.replace(dateResult.consumed, '').trim();
      }

      const timeResult = parseTimeFromText(keyword);
      if (timeResult) {
        targetTime = formatTime(timeResult.time);
        keyword = keyword.replace(timeResult.consumed, '').trim();
      }

      keyword = keyword.replace(/ã®?äºˆå®š$/, '').replace(/^ã®/, '').trim();

      const matches = findSchedule(targetDate, targetTime, keyword);
      if (matches.length === 0) {
        return { error: 'è©²å½“ã™ã‚‹äºˆå®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚' };
      }
      if (matches.length > 1) {
        return { error: `è¤‡æ•°ã®äºˆå®šãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ã‚‚ã†å°‘ã—å…·ä½“çš„ã«æŒ‡å®šã—ã¦ãã ã•ã„ã€‚\n${matches.map(s => `ãƒ»${s.date} ${s.time || ''} ${s.title}`).join('\n')}` };
      }

      const target = matches[0];

      // æ–°ã—ã„æ™‚é–“ã‚’è¨ˆç®—
      if (!target.time || target.time === 'æœªå®š') {
        return { error: 'æ™‚é–“æœªå®šã®äºˆå®šã¯æ™‚é–“å¤‰æ›´ã§ãã¾ã›ã‚“ã€‚' };
      }

      const currentHour = parseInt(target.time.slice(0, 2));
      const currentMin = parseInt(target.time.slice(2));
      let totalMinutes = currentHour * 60 + currentMin;

      const deltaMinutes = unit === 'æ™‚é–“' ? amount * 60 : amount;
      totalMinutes += isLater ? deltaMinutes : -deltaMinutes;

      if (totalMinutes < 0) totalMinutes += 24 * 60;
      if (totalMinutes >= 24 * 60) totalMinutes -= 24 * 60;

      const newHour = Math.floor(totalMinutes / 60);
      const newMin = totalMinutes % 60;
      const newTime = String(newHour).padStart(2, '0') + String(newMin).padStart(2, '0');

      return {
        type: 'modify',
        target,
        newSchedule: {
          ...target,
          time: newTime
        }
      };
    }

    function parseTargetAndAction(targetStr, action, newValueStr) {
      // å¯¾è±¡ã‹ã‚‰æ—¥ä»˜ãƒ»æ™‚é–“ãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡º
      let targetDate = null;
      let targetTime = null;
      let keyword = targetStr;

      const dateResult = parseDateFromText(targetStr);
      if (dateResult) {
        targetDate = `${dateResult.date.getMonth() + 1}/${dateResult.date.getDate()}`;
        keyword = targetStr.replace(dateResult.consumed, '').trim();
      }

      // æ™‚é–“ã‚‚ãƒ‘ãƒ¼ã‚¹
      const timeResult = parseTimeFromText(keyword);
      if (timeResult) {
        targetTime = formatTime(timeResult.time);
        keyword = keyword.replace(timeResult.consumed, '').trim();
      }

      // ã€Œã®äºˆå®šã€ã€Œã®ã€ãªã©ã‚’é™¤å»
      keyword = keyword.replace(/ã®?äºˆå®š$/, '').replace(/^ã®/, '').trim();

      // å®Œå…¨ä¸€è‡´ã‚’å„ªå…ˆã—ã¦æ¤œç´¢
      let target = null;

      // 1. æ—¥ä»˜ãƒ»æ™‚é–“ãƒ»ã‚¿ã‚¤ãƒˆãƒ«å…¨ã¦æŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€å®Œå…¨ä¸€è‡´ã‚’æ¢ã™
      if (targetDate && targetTime && keyword) {
        const exactMatch = schedules.find(s =>
          s.date === targetDate && s.time === targetTime && s.title === keyword
        );
        if (exactMatch) {
          target = exactMatch;
        }
      }

      // 2. å®Œå…¨ä¸€è‡´ãŒãªã‘ã‚Œã°éƒ¨åˆ†ä¸€è‡´ã§æ¤œç´¢
      if (!target) {
        const matches = findSchedule(targetDate, targetTime, keyword);

        if (matches.length === 0) {
          return { error: 'è©²å½“ã™ã‚‹äºˆå®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚' };
        }
        if (matches.length > 1) {
          return { error: `è¤‡æ•°ã®äºˆå®šãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ã‚‚ã†å°‘ã—å…·ä½“çš„ã«æŒ‡å®šã—ã¦ãã ã•ã„ã€‚\n${matches.map(s => `ãƒ»${s.date} ${s.time || ''} ${s.title}`).join('\n')}` };
        }
        target = matches[0];
      }

      if (action === 'delete') {
        return {
          type: 'delete',
          target
        };
      }

      // å¤‰æ›´ã®å ´åˆã€æ–°ã—ã„å€¤ã‚’ãƒ‘ãƒ¼ã‚¹
      if (action === 'modify') {
        let newDate = target.date;
        let newTime = target.time;
        let newFullDate = target.fullDate;

        const newDateResult = parseDateFromText(newValueStr);
        if (newDateResult) {
          newDate = `${newDateResult.date.getMonth() + 1}/${newDateResult.date.getDate()}`;
          newFullDate = newDateResult.date.toISOString();
        }

        const newTimeResult = parseTimeFromText(newValueStr);
        if (newTimeResult) {
          newTime = formatTime(newTimeResult.time);
        }

        return {
          type: 'modify',
          target,
          newSchedule: {
            ...target,
            date: newDate,
            time: newTime,
            fullDate: newFullDate
          }
        };
      }

      return null;
    }

    // ============================================
    // UIé–¢æ•°
    // ============================================
    function addMessage(type, text, buttonType = null) {
      const div = document.createElement('div');
      div.className = `message ${type}`;
      div.innerHTML = text;

      if (buttonType === 'confirm') {
        const btns = document.createElement('div');
        btns.className = 'confirm-buttons';
        btns.innerHTML = `
          <button class="btn-ok" onclick="handleConfirm()">OK</button>
          <button class="btn-cancel" onclick="handleCancel()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        `;
        div.appendChild(btns);
      } else if (buttonType === 'duplicate') {
        const btns = document.createElement('div');
        btns.className = 'confirm-buttons';
        btns.innerHTML = `
          <button class="btn-skip" onclick="handleDuplicateSkip()">åŒã˜äºˆå®šï¼ˆè¿½åŠ ã—ãªã„ï¼‰</button>
          <button class="btn-add" onclick="handleDuplicateAdd()">åˆ¥ã®äºˆå®šï¼ˆè¿½åŠ ã™ã‚‹ï¼‰</button>
        `;
        div.appendChild(btns);
      } else if (buttonType === 'warning') {
        const btns = document.createElement('div');
        btns.className = 'confirm-buttons';
        btns.innerHTML = `
          <button class="btn-add" onclick="handleWarningAdd()">è¿½åŠ ã™ã‚‹</button>
          <button class="btn-cancel" onclick="handleWarningCancel()">ã‚„ã‚ã‚‹</button>
        `;
        div.appendChild(btns);
      } else if (buttonType === 'modify-warning') {
        const btns = document.createElement('div');
        btns.className = 'confirm-buttons';
        btns.innerHTML = `
          <button class="btn-add" onclick="handleModifyWarningConfirm()">å¤‰æ›´ã™ã‚‹</button>
          <button class="btn-cancel" onclick="handleModifyWarningCancel()">ã‚„ã‚ã‚‹</button>
        `;
        div.appendChild(btns);
      } else if (buttonType && buttonType.type === 'conflict-choice') {
        const btns = document.createElement('div');
        btns.className = 'confirm-buttons';
        btns.style.flexWrap = 'wrap';
        buttonType.choices.forEach((choice, idx) => {
          const btn = document.createElement('button');
          btn.className = 'btn-add';
          btn.textContent = choice;
          btn.onclick = () => handleConflictChoice(idx);
          btns.appendChild(btn);
        });
        const bothBtn = document.createElement('button');
        bothBtn.className = 'btn-skip';
        bothBtn.textContent = 'ä¸¡æ–¹æ®‹ã™';
        bothBtn.onclick = () => handleConflictChoice(-1);
        btns.appendChild(bothBtn);
        div.appendChild(btns);
      } else if (buttonType && buttonType.type === 'exact-duplicate') {
        const btns = document.createElement('div');
        btns.className = 'confirm-buttons';
        const mergeBtn = document.createElement('button');
        mergeBtn.className = 'btn-add';
        mergeBtn.textContent = '1ä»¶ã«ã¾ã¨ã‚ã‚‹';
        mergeBtn.onclick = () => handleConflictChoice(0);
        btns.appendChild(mergeBtn);
        const keepBtn = document.createElement('button');
        keepBtn.className = 'btn-skip';
        keepBtn.textContent = `${buttonType.count}ä»¶ã¨ã‚‚æ®‹ã™`;
        keepBtn.onclick = () => handleConflictChoice(-1);
        btns.appendChild(keepBtn);
        div.appendChild(btns);
      } else if (buttonType && buttonType.type === 'double-booking-select') {
        // ç¬¬1æ®µéš: ã©ã®äºˆå®šã‚’ä¿®æ­£ã™ã‚‹ã‹é¸æŠ
        const btns = document.createElement('div');
        btns.className = 'confirm-buttons';
        btns.style.flexWrap = 'wrap';
        buttonType.schedules.forEach((s, idx) => {
          const btn = document.createElement('button');
          btn.className = 'btn-add';
          btn.textContent = s.title;
          btn.onclick = () => handleDoubleBookingSelect(idx);
          btns.appendChild(btn);
        });
        const keepBtn = document.createElement('button');
        keepBtn.className = 'btn-skip';
        keepBtn.textContent = 'ã“ã®ã¾ã¾';
        keepBtn.onclick = () => handleDoubleBookingSelect(-1);
        btns.appendChild(keepBtn);
        div.appendChild(btns);
      } else if (buttonType && buttonType.type === 'double-booking-action') {
        // ç¬¬2æ®µéš: é¸æŠã—ãŸäºˆå®šã‚’ã©ã†ã™ã‚‹ã‹
        const btns = document.createElement('div');
        btns.className = 'confirm-buttons';
        btns.style.flexWrap = 'wrap';
        const otherBtn = document.createElement('button');
        otherBtn.className = 'btn-add';
        otherBtn.textContent = 'ä»–äººã®äºˆå®šã«ã™ã‚‹';
        otherBtn.onclick = () => handleDoubleBookingAction('other');
        btns.appendChild(otherBtn);
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn-delete';
        deleteBtn.textContent = 'å‰Šé™¤ã™ã‚‹';
        deleteBtn.onclick = () => handleDoubleBookingAction('delete');
        btns.appendChild(deleteBtn);
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'btn-skip';
        cancelBtn.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
        cancelBtn.onclick = () => handleDoubleBookingAction('cancel');
        btns.appendChild(cancelBtn);
        div.appendChild(btns);
      }

      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆisOtherã‚‚æ¡ä»¶ã«å«ã‚ã‚‹ï¼šè‡ªåˆ†ã®äºˆå®šã¨ä»–äººã®äºˆå®šã¯åˆ¥æ‰±ã„ï¼‰
    function isDuplicate(schedule, exclude = null) {
      return schedules.some(s =>
        s !== exclude &&
        s.date === schedule.date &&
        s.time === schedule.time &&
        s.title === schedule.title &&
        !!s.isOther === !!schedule.isOther
      );
    }

    // æœ‰åŠ¹ãªæ™‚é–“ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆ4æ¡ã®æ•°å­—ï¼‰
    function isValidTime(time) {
      return time && time !== 'æœªå®š' && /^\d{4}$/.test(time);
    }

    // ãƒ€ãƒ–ãƒ«ãƒ–ãƒƒã‚­ãƒ³ã‚°ãƒã‚§ãƒƒã‚¯ï¼ˆ2æ™‚é–“ä»¥å†…ã®äºˆå®šã‚’æ¤œå‡ºã€excludeã§æŒ‡å®šã—ãŸäºˆå®šã¯é™¤å¤–ï¼‰
    function findNearbySchedule(schedule, exclude = null) {
      if (!isValidTime(schedule.time) || schedule.isOther) return null;

      const newTime = parseInt(schedule.time.slice(0, 2)) * 60 + parseInt(schedule.time.slice(2));

      for (const s of schedules) {
        // é™¤å¤–æŒ‡å®šã•ã‚ŒãŸäºˆå®šã¯ã‚¹ã‚­ãƒƒãƒ—
        if (s === exclude) continue;
        // åŒã˜æ—¥ã€æœ‰åŠ¹ãªæ™‚é–“ã‚ã‚Šã€è‡ªåˆ†ã®äºˆå®šï¼ˆisOther: falseï¼‰ã®ã¿
        if (s.date === schedule.date && isValidTime(s.time) && !s.isOther) {
          const existingTime = parseInt(s.time.slice(0, 2)) * 60 + parseInt(s.time.slice(2));
          const diff = Math.abs(newTime - existingTime);
          if (diff > 0 && diff <= 120) { // 2æ™‚é–“ä»¥å†…ï¼ˆåŒä¸€æ™‚åˆ»ã¯é™¤ãï¼‰
            return s;
          }
        }
      }
      return null;
    }

    // åŒã˜æ—¥æ™‚ã«æ—¢å­˜ã®è‡ªåˆ†ã®äºˆå®šãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆå¤‰æ›´æ™‚ç”¨ï¼‰
    function findSameTimeSchedules(schedule, exclude = null) {
      if (!isValidTime(schedule.time)) return [];

      return schedules.filter(s =>
        s !== exclude &&
        !s.isOther &&
        s.date === schedule.date &&
        s.time === schedule.time
      );
    }

    // åŒã˜æ—¥æ™‚ã«è‡ªåˆ†ã®äºˆå®šãŒè¤‡æ•°ã‚ã‚‹å ´åˆã‚’æ¤œå‡ºï¼ˆèµ·å‹•æ™‚ãƒã‚§ãƒƒã‚¯ç”¨ï¼‰
    function findDoubleBookings() {
      const groups = {};
      schedules.forEach(s => {
        if (!s.isOther && isValidTime(s.time)) {
          const key = `${s.date}_${s.time}`;
          if (!groups[key]) groups[key] = [];
          groups[key].push(s);
        }
      });

      // 2ä»¶ä»¥ä¸Šã‚ã‚‹æ—¥æ™‚ã‚’è¿”ã™
      const conflicts = [];
      Object.keys(groups).forEach(key => {
        if (groups[key].length >= 2) {
          conflicts.push({
            date: groups[key][0].date,
            time: groups[key][0].time,
            schedules: groups[key]
          });
        }
      });
      return conflicts;
    }

    // ä¸€æ‹¬å…¥åŠ›æ™‚ã®åŒä¸€æ—¥æ™‚ã®äºˆå®šã‚’æ¤œå‡ºï¼ˆå®Œå…¨é‡è¤‡ã¨ãƒ€ãƒ–ãƒ«ãƒ–ãƒƒã‚­ãƒ³ã‚°ä¸¡æ–¹ï¼‰
    function findSameTimeConflicts(schedulesArray) {
      const groups = {};
      schedulesArray.forEach((s, idx) => {
        if (isValidTime(s.time) && !s.isOther) {
          const key = `${s.date}_${s.time}`;
          if (!groups[key]) groups[key] = [];
          groups[key].push({ schedule: s, index: idx });
        }
      });

      const conflicts = [];
      Object.entries(groups).forEach(([key, items]) => {
        if (items.length <= 1) return;

        // åŒã˜ã‚¿ã‚¤ãƒˆãƒ«ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’æ¤œå‡ºï¼ˆå®Œå…¨é‡è¤‡ï¼‰
        const titleGroups = {};
        items.forEach(item => {
          const title = item.schedule.title;
          if (!titleGroups[title]) titleGroups[title] = [];
          titleGroups[title].push(item);
        });

        // å®Œå…¨é‡è¤‡ï¼ˆåŒã˜ã‚¿ã‚¤ãƒˆãƒ«ãŒ2ä»¶ä»¥ä¸Šï¼‰
        Object.entries(titleGroups).forEach(([title, titleItems]) => {
          if (titleItems.length > 1) {
            conflicts.push({
              key,
              items: titleItems,
              type: 'exact-duplicate',
              title
            });
          }
        });

        // ãƒ€ãƒ–ãƒ«ãƒ–ãƒƒã‚­ãƒ³ã‚°ï¼ˆç•°ãªã‚‹ã‚¿ã‚¤ãƒˆãƒ«ãŒåŒã˜æ—¥æ™‚ï¼‰
        const uniqueTitles = Object.keys(titleGroups);
        if (uniqueTitles.length > 1) {
          // å„ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰1ä»¶ãšã¤å–å¾—
          const representativeItems = uniqueTitles.map(title => titleGroups[title][0]);
          conflicts.push({
            key,
            items: representativeItems,
            type: 'double-booking'
          });
        }
      });

      return conflicts;
    }

    function formatScheduleDisplay(s) {
      const timeStr = s.time ? ` ${s.time}` : '';
      if (s.isOther) {
        return `(${s.date}${timeStr} ${s.title})`;
      }
      return `${s.date}${timeStr} ${s.title}`;
    }

    // ã‚½ãƒ¼ãƒˆç”¨ã®æ™‚é–“å€¤ã‚’å–å¾—ï¼ˆæœªå®šã¯æœ€å¾Œã«ï¼‰
    function getSortableTime(time) {
      if (!time || time === 'æœªå®š') return '9999';
      return time;
    }

    function formatScheduleList() {
      if (schedules.length === 0) {
        return 'äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“';
      }

      const sorted = [...schedules].sort((a, b) => {
        const dateA = new Date(a.fullDate);
        const dateB = new Date(b.fullDate);
        if (dateA.getTime() !== dateB.getTime()) return dateA - dateB;
        return getSortableTime(a.time) > getSortableTime(b.time) ? 1 : -1;
      });

      const grouped = {};
      sorted.forEach(s => {
        if (!grouped[s.date]) grouped[s.date] = [];
        grouped[s.date].push(s);
      });

      // å›ºå®šå¹…ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆï¼ˆæ—¥ä»˜5æ–‡å­— + ã‚¹ãƒšãƒ¼ã‚¹1æ–‡å­— = 6æ–‡å­—åˆ†ï¼‰
      const INDENT = '      ';  // åŠè§’ã‚¹ãƒšãƒ¼ã‚¹6ã¤

      let lines = ['äºˆå®šï¼'];
      Object.keys(grouped).forEach(date => {
        // æ—¥ä»˜ã‚’å›ºå®šå¹…ï¼ˆ5æ–‡å­—ï¼‰ã«ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°
        const paddedDate = date.padEnd(5, ' ');
        grouped[date].forEach((s, idx) => {
          const timeStr = s.time ? `${s.time} ` : '';
          let line;
          if (s.isOther) {
            const content = `(${timeStr}${s.title})`;
            if (idx === 0) {
              line = `<span class="other-schedule">${paddedDate} ${content}</span>`;
            } else {
              line = `<span class="other-schedule">${INDENT}${content}</span>`;
            }
          } else {
            const content = `${timeStr}${s.title}`;
            if (idx === 0) {
              line = `${paddedDate} ${content}`;
            } else {
              line = `${INDENT}${content}`;
            }
          }
          lines.push(line);
        });
      });

      return lines.join('<br>');
    }

    function showScheduleList() {
      const text = formatScheduleList();
      const copyButton = schedules.length > 0 ? '<button class="copy-schedule-btn" onclick="copyScheduleToClipboard()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>' : '';
      addMessage('system', `<div class="schedule-text">${text}</div>${copyButton}`);
    }

    // å¤–éƒ¨ã‚³ãƒ”ãƒ¼ç”¨ã®ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
    function formatScheduleForCopy() {
      if (schedules.length === 0) return '';

      const sorted = [...schedules].sort((a, b) => {
        const dateA = new Date(a.fullDate);
        const dateB = new Date(b.fullDate);
        if (dateA.getTime() !== dateB.getTime()) return dateA - dateB;
        return getSortableTime(a.time) > getSortableTime(b.time) ? 1 : -1;
      });

      const grouped = {};
      sorted.forEach(s => {
        if (!grouped[s.date]) grouped[s.date] = [];
        grouped[s.date].push(s);
      });

      let lines = [];
      Object.keys(grouped).forEach(date => {
        // æ—¥ä»˜ã‚’å›ºå®šå¹…ã«ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆä¾‹: "1/20" â†’ "1/20  "ã§6æ–‡å­—ï¼‰
        const paddedDate = date.padEnd(6, ' ');
        grouped[date].forEach((s, idx) => {
          const timeStr = s.time && s.time !== 'æœªå®š' ? `${s.time} ` : '';
          let line;
          if (s.isOther) {
            const content = `(${timeStr}${s.title})`;
            line = idx === 0 ? `${paddedDate}${content}` : `      ${content}`;
          } else {
            const content = `${timeStr}${s.title}`;
            line = idx === 0 ? `${paddedDate}${content}` : `      ${content}`;
          }
          lines.push(line);
        });
      });

      return lines.join('\n');
    }

    // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
    function copyScheduleToClipboard() {
      const text = formatScheduleForCopy();
      if (!text) return;

      navigator.clipboard.writeText(text).then(() => {
        addMessage('system', 'ğŸ“‹ äºˆå®šã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
      }).catch(err => {
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆå¤ã„ãƒ–ãƒ©ã‚¦ã‚¶ç”¨ï¼‰
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        addMessage('system', 'ğŸ“‹ äºˆå®šã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
      });
    }

    function setInputEnabled(enabled) {
      inputField.disabled = !enabled;
      document.querySelector('.input-form button').disabled = !enabled;
    }

    // ============================================
    // ç¢ºèªå‡¦ç†
    // ============================================
    function handleConfirm() {
      if (!pendingAction) return;

      saveForUndo();
      if (pendingAction.type === 'add') {
        schedules.push(pendingAction.schedule);
      } else if (pendingAction.type === 'add-multiple') {
        schedules.push(...pendingAction.schedules);
      } else if (pendingAction.type === 'add-repeat') {
        // ç¹°ã‚Šè¿”ã—äºˆå®šã‚’è¿½åŠ ã—ã€ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚‚ä¿å­˜
        schedules.push(...pendingAction.schedules);
        repeatPatterns.push(pendingAction.pattern);
        localStorage.setItem('repeatPatterns', JSON.stringify(repeatPatterns));
        updateRepeatPatternsList();
      } else if (pendingAction.type === 'delete') {
        schedules = schedules.filter(s => s !== pendingAction.target);
      } else if (pendingAction.type === 'delete-multiple') {
        const targetsSet = new Set(pendingAction.targets);
        schedules = schedules.filter(s => !targetsSet.has(s));
        addMessage('system', `${pendingAction.targets.length}ä»¶ã®äºˆå®šã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
      } else if (pendingAction.type === 'modify') {
        // é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆå¤‰æ›´å¯¾è±¡è‡ªèº«ã¯é™¤å¤–ï¼‰
        if (isDuplicate(pendingAction.newSchedule, pendingAction.target)) {
          addMessage('system', 'ã“ã®æ™‚é–“ã«æ—¢ã«åŒã˜äºˆå®šãŒã‚ã‚Šã¾ã™ã€‚');
          pendingAction = null;
          setInputEnabled(true);
          return;
        }

        // åŒã˜æ—¥æ™‚ã«æ—¢å­˜ã®äºˆå®šãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆå¤‰æ›´å¯¾è±¡è‡ªèº«ã¯é™¤å¤–ï¼‰
        const sameTimeSchedules = findSameTimeSchedules(pendingAction.newSchedule, pendingAction.target);
        if (sameTimeSchedules.length > 0) {
          const titles = sameTimeSchedules.map(s => s.title).join('ã€');
          const confirmText = `${formatScheduleDisplay(pendingAction.target)} â†’ ${formatScheduleDisplay(pendingAction.newSchedule)} ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ<br><span style="color:#e74c3c">âš  ${pendingAction.newSchedule.date} ${pendingAction.newSchedule.time} ã«æ—¢ã«äºˆå®šãŒã‚ã‚Šã¾ã™ï¼ˆ${titles}ï¼‰</span>`;
          addMessage('confirm', confirmText, 'modify-warning');
          return;
        }

        // 2æ™‚é–“ä»¥å†…ã®äºˆå®šãƒã‚§ãƒƒã‚¯ï¼ˆå¤‰æ›´å¯¾è±¡è‡ªèº«ã¯é™¤å¤–ï¼‰
        const nearby = findNearbySchedule(pendingAction.newSchedule, pendingAction.target);
        if (nearby) {
          const confirmText = `${formatScheduleDisplay(pendingAction.target)} â†’ ${formatScheduleDisplay(pendingAction.newSchedule)} ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ<br><span style="color:#e74c3c">âš  ${formatScheduleDisplay(nearby)} ã®2æ™‚é–“ä»¥å†…ã«äºˆå®šãŒã‚ã‚Šã¾ã™</span>`;
          addMessage('confirm', confirmText, 'modify-warning');
          return;
        }

        const idx = schedules.indexOf(pendingAction.target);
        if (idx !== -1) {
          schedules[idx] = pendingAction.newSchedule;
        }
      }

      localStorage.setItem('schedules', JSON.stringify(schedules));
      showScheduleList();
      pendingAction = null;
      setInputEnabled(true);
    }

    function handleCancel() {
      addMessage('system', 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚');
      pendingAction = null;
      setInputEnabled(true);
    }

    function handleDuplicateSkip() {
      addMessage('system', 'è¿½åŠ ã—ã¾ã›ã‚“ã§ã—ãŸã€‚');
      pendingAction = null;
      setInputEnabled(true);
    }

    function handleDuplicateAdd() {
      if (pendingAction && pendingAction.schedule) {
        saveForUndo();
        schedules.push(pendingAction.schedule);
        localStorage.setItem('schedules', JSON.stringify(schedules));
        showScheduleList();
      }
      pendingAction = null;
      setInputEnabled(true);
    }

    function handleWarningAdd() {
      if (pendingAction && pendingAction.schedule) {
        saveForUndo();
        schedules.push(pendingAction.schedule);
        localStorage.setItem('schedules', JSON.stringify(schedules));
        showScheduleList();
      }
      pendingAction = null;
      setInputEnabled(true);
    }

    function handleWarningCancel() {
      addMessage('system', 'è¿½åŠ ã—ã¾ã›ã‚“ã§ã—ãŸã€‚');
      pendingAction = null;
      setInputEnabled(true);
    }

    function handleModifyWarningConfirm() {
      if (pendingAction && pendingAction.target && pendingAction.newSchedule) {
        saveForUndo();
        const idx = schedules.indexOf(pendingAction.target);
        if (idx !== -1) {
          schedules[idx] = pendingAction.newSchedule;
        }
        localStorage.setItem('schedules', JSON.stringify(schedules));
        showScheduleList();
      }
      pendingAction = null;
      setInputEnabled(true);
    }

    function handleModifyWarningCancel() {
      addMessage('system', 'å¤‰æ›´ã—ã¾ã›ã‚“ã§ã—ãŸã€‚');
      pendingAction = null;
      setInputEnabled(true);
    }

    // ç¬¬1æ®µéš: ã©ã®äºˆå®šã‚’ä¿®æ­£ã™ã‚‹ã‹é¸æŠ
    function handleDoubleBookingSelect(idx) {
      if (!pendingAction || pendingAction.type !== 'resolve-double-booking') return;

      if (idx >= 0) {
        // é¸æŠã•ã‚ŒãŸäºˆå®šã‚’pendingActionã«ä¿å­˜ã—ã¦ç¬¬2æ®µéšã¸
        pendingAction.selectedSchedule = pendingAction.currentConflict.schedules[idx];
        pendingAction.selectedIndex = idx;
        showDoubleBookingActions();
      } else {
        // ã€Œã“ã®ã¾ã¾ã€ã‚’é¸æŠã—ãŸå ´åˆã¯æ¬¡ã®ãƒ€ãƒ–ãƒ«ãƒ–ãƒƒã‚­ãƒ³ã‚°ã¸
        moveToNextDoubleBooking();
      }
    }

    // ç¬¬2æ®µéš: é¸æŠã—ãŸäºˆå®šã‚’ã©ã†ã™ã‚‹ã‹è¡¨ç¤º
    function showDoubleBookingActions() {
      const schedule = pendingAction.selectedSchedule;
      const confirmText = `ã€Œ${schedule.title}ã€ã‚’ã©ã†ã—ã¾ã™ã‹ï¼Ÿ`;
      addMessage('confirm', confirmText, { type: 'double-booking-action' });
    }

    // ç¬¬2æ®µéš: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
    function handleDoubleBookingAction(action) {
      if (!pendingAction || pendingAction.type !== 'resolve-double-booking') return;

      const targetSchedule = pendingAction.selectedSchedule;
      const scheduleIdx = schedules.indexOf(targetSchedule);

      if (action === 'other') {
        // ä»–äººã®äºˆå®šã«å¤‰æ›
        if (scheduleIdx !== -1) {
          saveForUndo();
          schedules[scheduleIdx].isOther = true;
          localStorage.setItem('schedules', JSON.stringify(schedules));
          addMessage('system', `ã€Œ${targetSchedule.title}ã€ã‚’ä»–äººã®äºˆå®šã«å¤‰æ›´ã—ã¾ã—ãŸã€‚`);
        }
        moveToNextDoubleBooking();
      } else if (action === 'delete') {
        // å‰Šé™¤
        if (scheduleIdx !== -1) {
          saveForUndo();
          schedules.splice(scheduleIdx, 1);
          localStorage.setItem('schedules', JSON.stringify(schedules));
          addMessage('system', `ã€Œ${targetSchedule.title}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
        }
        moveToNextDoubleBooking();
      } else if (action === 'cancel') {
        // ã‚­ãƒ£ãƒ³ã‚»ãƒ« - ç¬¬1æ®µéšã«æˆ»ã‚‹
        showNextDoubleBooking();
      }
    }

    // æ¬¡ã®ãƒ€ãƒ–ãƒ«ãƒ–ãƒƒã‚­ãƒ³ã‚°ã¸ç§»å‹•
    function moveToNextDoubleBooking() {
      pendingAction.conflictIndex++;
      if (pendingAction.conflictIndex < pendingAction.conflicts.length) {
        showNextDoubleBooking();
      } else {
        pendingAction = null;
        setInputEnabled(true);
        showScheduleList();
      }
    }

    function showNextDoubleBooking() {
      const conflict = pendingAction.conflicts[pendingAction.conflictIndex];
      pendingAction.currentConflict = conflict;
      const confirmText = `${conflict.date} ${conflict.time} ã«äºˆå®šãŒé‡ãªã£ã¦ã„ã¾ã™ã€‚ã©ã®äºˆå®šã‚’ä¿®æ­£ã—ã¾ã™ã‹ï¼Ÿ`;
      addMessage('confirm', confirmText, { type: 'double-booking-select', schedules: conflict.schedules });
    }

    function handleConflictChoice(choiceIdx) {
      if (!pendingAction || pendingAction.type !== 'resolve-conflict') return;

      const conflict = pendingAction.currentConflict;
      if (choiceIdx === -1) {
        // ä¸¡æ–¹æ®‹ã™ - ä½•ã‚‚ã—ãªã„
      } else {
        // é¸æŠã•ã‚ŒãŸã‚‚ã®ä»¥å¤–ã‚’é™¤å¤–
        const keepIndex = conflict.items[choiceIdx].index;
        conflict.items.forEach(item => {
          if (item.index !== keepIndex) {
            pendingAction.schedulesToRemove.add(item.index);
          }
        });
      }

      // æ¬¡ã®è¡çªã‚’ãƒã‚§ãƒƒã‚¯
      processNextConflict();
    }

    function processNextConflict() {
      const { allSchedules, conflicts, schedulesToRemove } = pendingAction;

      if (conflicts.length === 0) {
        // å…¨ã¦ã®è¡çªã‚’è§£æ±º â†’ æœ€çµ‚ç¢ºèª
        const finalSchedules = allSchedules.filter((_, idx) => !schedulesToRemove.has(idx));

        if (finalSchedules.length === 0) {
          addMessage('system', 'è¿½åŠ ã™ã‚‹äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
          pendingAction = null;
          setInputEnabled(true);
          return;
        }

        const listText = finalSchedules.map(s => formatScheduleDisplay(s)).join('<br>');
        const confirmText = `${finalSchedules.length}ä»¶ã®äºˆå®šã‚’è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ<br>${listText}`;
        addMessage('confirm', confirmText, 'confirm');
        pendingAction = { type: 'add-multiple', schedules: finalSchedules };
        return;
      }

      // æ¬¡ã®è¡çªã‚’å‡¦ç†
      const nextConflict = conflicts.shift();
      // æ—¢ã«é™¤å¤–ã•ã‚ŒãŸã‚‚ã®ã‚’é™¤ã
      nextConflict.items = nextConflict.items.filter(item => !schedulesToRemove.has(item.index));

      if (nextConflict.items.length <= 1) {
        // è¡çªãŒè§£æ¶ˆã•ã‚ŒãŸ
        processNextConflict();
        return;
      }

      pendingAction.currentConflict = nextConflict;

      const [date, time] = nextConflict.key.split('_');

      if (nextConflict.type === 'exact-duplicate') {
        // å®Œå…¨é‡è¤‡
        const confirmText = `${date} ${time} ã«åŒã˜äºˆå®šãŒ${nextConflict.items.length}ä»¶ã‚ã‚Šã¾ã™ï¼š${nextConflict.title}`;
        addMessage('confirm', confirmText, { type: 'exact-duplicate', count: nextConflict.items.length });
      } else {
        // ãƒ€ãƒ–ãƒ«ãƒ–ãƒƒã‚­ãƒ³ã‚°
        const choices = nextConflict.items.map(item => item.schedule.title);
        const confirmText = `${date} ${time} ã«${nextConflict.items.length}ä»¶ã®äºˆå®šãŒã‚ã‚Šã¾ã™ã€‚ã©ã¡ã‚‰ã‚’æ®‹ã—ã¾ã™ã‹ï¼Ÿ`;
        addMessage('confirm', confirmText, { type: 'conflict-choice', choices });
      }
    }

    // ============================================
    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
    // ============================================
    inputForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const input = inputField.value.trim();
      if (!input) return;

      addMessage('user', input);
      inputField.value = '';

      // äºˆå®šç¢ºèªãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆå³å¯†åˆ¤å®šï¼‰
      // æ•°å­—ãŒå«ã¾ã‚Œã¦ã„ãŸã‚‰æ–°è¦è¿½åŠ ã¨ã—ã¦å‡¦ç†
      const scheduleCheckPatterns = ['äºˆå®š', 'äºˆå®šç¢ºèª', 'ä¸€è¦§', 'ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«', 'ä»Šã©ã†ãªã£ã¦ã‚‹', 'ä»Šã©ã†ãªã£ã¦ã‚‹ï¼Ÿ'];
      const normalizedInput = input.trim().replace(/[ï¼Ÿ?ï¼!]/g, '');
      const isScheduleCheck = scheduleCheckPatterns.includes(normalizedInput) ||
        (scheduleCheckPatterns.some(p => normalizedInput === p) && !/\d/.test(input));
      if (isScheduleCheck) {
        showScheduleList();
        return;
      }

      // Undo ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
      const undoPatterns = ['å–ã‚Šæ¶ˆã—', 'å–æ¶ˆã—', 'å–æ¶ˆ', 'å–ã‚Šæ¶ˆ', 'å…ƒã«æˆ»ã™', 'å…ƒã«æˆ»ã—ã¦', 'undo', 'ã‚¢ãƒ³ãƒ‰ã‚¥'];
      if (undoPatterns.includes(normalizedInput.toLowerCase())) {
        performUndo();
        return;
      }

      // ç¹°ã‚Šè¿”ã—äºˆå®šã®ãƒã‚§ãƒƒã‚¯
      const repeatResult = parseRepeatSchedule(input);
      if (repeatResult) {
        const newSchedules = generateRepeatSchedules(repeatResult.targetDay, repeatResult.time, repeatResult.title);
        if (newSchedules.length > 0) {
          const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
          const confirmText = `æ¯é€±${weekdays[repeatResult.targetDay]}æ›œã€Œ${repeatResult.title}ã€ã‚’${newSchedules.length}ä»¶è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ`;
          addMessage('confirm', confirmText, 'confirm');
          // ãƒ‘ã‚¿ãƒ¼ãƒ³æƒ…å ±ã‚‚ä¸€ç·’ã«ä¿å­˜
          const repeatPattern = {
            id: Date.now(),
            dayOfWeek: repeatResult.targetDay,
            time: repeatResult.time,
            title: repeatResult.title
          };
          pendingAction = { type: 'add-repeat', schedules: newSchedules, pattern: repeatPattern };
          setInputEnabled(false);
        } else {
          addMessage('system', 'è¿½åŠ ã§ãã‚‹äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼ˆå…¨ã¦é‡è¤‡ï¼‰ã€‚');
        }
        return;
      }

      // ä¸€æ‹¬å‰Šé™¤ã®ãƒã‚§ãƒƒã‚¯ï¼ˆè¤‡æ•°è¡Œ + å‰Šé™¤ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼‰
      const bulkDeleteResult = parseBulkDelete(input);
      if (bulkDeleteResult) {
        if (bulkDeleteResult.matches.length > 0) {
          const confirmText = `${bulkDeleteResult.matches.length}ä»¶ã®äºˆå®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ<br>${bulkDeleteResult.matches.map(s => `ãƒ»${s.date} ${s.time || ''} ${s.title}`).join('<br>')}`;
          addMessage('confirm', confirmText, 'confirm');
          pendingAction = { type: 'delete-multiple', targets: bulkDeleteResult.matches };
          setInputEnabled(false);
        } else {
          addMessage('system', 'è©²å½“ã™ã‚‹äºˆå®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
        }
        return;
      }

      // ã¾ãšå¤‰æ›´ãƒ»å‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ãƒã‚§ãƒƒã‚¯
      const modRequest = parseModificationRequest(input);
      if (modRequest) {
        if (modRequest.error) {
          addMessage('system', modRequest.error);
          return;
        }

        if (modRequest.type === 'delete') {
          const confirmText = `${formatScheduleDisplay(modRequest.target)} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`;
          addMessage('confirm', confirmText, 'confirm');
          pendingAction = modRequest;
          setInputEnabled(false);
          return;
        }

        if (modRequest.type === 'modify') {
          // é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆå¤‰æ›´å¯¾è±¡è‡ªèº«ã¯é™¤å¤–ï¼‰
          if (isDuplicate(modRequest.newSchedule, modRequest.target)) {
            addMessage('system', 'ã“ã®æ™‚é–“ã«æ—¢ã«åŒã˜äºˆå®šãŒã‚ã‚Šã¾ã™ã€‚');
            return;
          }

          // ãƒ€ãƒ–ãƒ«ãƒ–ãƒƒã‚­ãƒ³ã‚°ãƒã‚§ãƒƒã‚¯ï¼ˆå¤‰æ›´å¯¾è±¡è‡ªèº«ã¯é™¤å¤–ï¼‰
          const nearby = findNearbySchedule(modRequest.newSchedule, modRequest.target);
          if (nearby) {
            const confirmText = `${formatScheduleDisplay(modRequest.target)} â†’ ${formatScheduleDisplay(modRequest.newSchedule)} ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ<br><span style="color:#e74c3c">âš  ${formatScheduleDisplay(nearby)} ã®2æ™‚é–“ä»¥å†…ã«äºˆå®šãŒã‚ã‚Šã¾ã™</span>`;
            addMessage('confirm', confirmText, 'modify-warning');
            pendingAction = modRequest;
            setInputEnabled(false);
            return;
          }

          const confirmText = `${formatScheduleDisplay(modRequest.target)} â†’ ${formatScheduleDisplay(modRequest.newSchedule)} ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ`;
          addMessage('confirm', confirmText, 'confirm');
          pendingAction = modRequest;
          setInputEnabled(false);
          return;
        }
      }

      // æ–°è¦è¿½åŠ 
      const isOther = input.startsWith('(') || input.startsWith('ï¼ˆ');
      // å…ˆé ­ãŒé–‹ãã‚«ãƒƒã‚³ã§å§‹ã¾ã‚‹å ´åˆã®ã¿ã€ä¸¡ç«¯ã®ã‚«ãƒƒã‚³ã‚’å‰Šé™¤
      const cleanInput = isOther ? input.replace(/^[ï¼ˆ(]/, '').replace(/[)ï¼‰]$/, '') : input;

      // è¤‡æ•°äºˆå®šã‹ãƒã‚§ãƒƒã‚¯
      const multipleResult = parseMultipleSchedules(cleanInput);
      if (multipleResult) {
        const multipleSchedules = multipleResult.schedules;
        const skippedSchedules = multipleResult.skipped;

        // ã‚¹ã‚­ãƒƒãƒ—ã•ã‚ŒãŸäºˆå®šãŒã‚ã‚‹å ´åˆã¯è­¦å‘Šã‚’è¡¨ç¤º
        if (skippedSchedules.length > 0) {
          const skippedText = skippedSchedules.join('<br>');
          addMessage('system', `âš  ãƒ‘ãƒ¼ã‚¹ã§ããªã‹ã£ãŸéƒ¨åˆ†ãŒã‚ã‚Šã¾ã™ï¼š<br>${skippedText}`);
        }

        // æ—¢ã«isOther: trueãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹äºˆå®šã¯ä¸Šæ›¸ãã—ãªã„
        multipleSchedules.forEach(s => s.isOther = s.isOther || isOther);
        const originalCount = multipleSchedules.length;

        // æ—¢å­˜äºˆå®šã¨ã®é‡è¤‡ã®ã¿è‡ªå‹•é™¤å¤–ï¼ˆå…¥åŠ›å†…ã®é‡è¤‡ã¯é¸æŠå¼ã§ç¢ºèªï¼‰
        const uniqueSchedules = [];
        let existingDupCount = 0;
        for (const s of multipleSchedules) {
          const isDupInExisting = isDuplicate(s);
          if (!isDupInExisting) {
            uniqueSchedules.push(s);
          } else {
            existingDupCount++;
          }
        }

        if (uniqueSchedules.length === 0) {
          addMessage('system', `${originalCount}ä»¶å…¨ã¦æ—¢ã«ç™»éŒ²æ¸ˆã¿ã§ã™ã€‚`);
          return;
        }

        // æ—¢å­˜äºˆå®šã¨ã®é‡è¤‡é™¤å¤–ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        if (existingDupCount > 0) {
          addMessage('system', `${existingDupCount}ä»¶ã¯æ—¢ã«ç™»éŒ²æ¸ˆã¿ã®ãŸã‚é™¤å¤–ã—ã¾ã—ãŸã€‚`);
        }

        // å®Œå…¨é‡è¤‡ã¨ãƒ€ãƒ–ãƒ«ãƒ–ãƒƒã‚­ãƒ³ã‚°ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆåŒä¸€æ—¥æ™‚ã®äºˆå®šï¼‰
        const conflicts = findSameTimeConflicts(uniqueSchedules);

        if (conflicts.length > 0) {
          // è¡çªè§£æ±ºãƒ¢ãƒ¼ãƒ‰ã¸
          pendingAction = {
            type: 'resolve-conflict',
            allSchedules: uniqueSchedules,
            conflicts: conflicts,
            schedulesToRemove: new Set(),
            currentConflict: null
          };
          setInputEnabled(false);
          processNextConflict();
          return;
        }

        // è¡çªãªã— â†’ æœ€çµ‚ç¢ºèª
        const listText = uniqueSchedules.map(s => formatScheduleDisplay(s)).join('<br>');
        const confirmText = `${uniqueSchedules.length}ä»¶ã®äºˆå®šã‚’è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ<br>${listText}`;
        addMessage('confirm', confirmText, 'confirm');
        pendingAction = { type: 'add-multiple', schedules: uniqueSchedules };
        setInputEnabled(false);
        return;
      }

      // å˜ä¸€äºˆå®š
      const parsed = parseScheduleInput(cleanInput);
      if (parsed) {
        // parseScheduleInputã§ã€Œä»–äººã®äºˆå®šã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒæ¤œå‡ºã•ã‚ŒãŸå ´åˆã€ã¾ãŸã¯ã‚«ãƒƒã‚³ã§å›²ã¾ã‚Œã¦ã„ãŸå ´åˆ
        parsed.isOther = parsed.isOther || isOther;

        // é‡è¤‡ãƒã‚§ãƒƒã‚¯
        if (isDuplicate(parsed)) {
          const confirmText = `${formatScheduleDisplay(parsed)} ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚`;
          addMessage('confirm', confirmText, 'duplicate');
          pendingAction = { type: 'duplicate', schedule: parsed };
          setInputEnabled(false);
        } else {
          // ãƒ€ãƒ–ãƒ«ãƒ–ãƒƒã‚­ãƒ³ã‚°ãƒã‚§ãƒƒã‚¯ï¼ˆè‡ªåˆ†ã®äºˆå®šã®ã¿ï¼‰
          const nearby = findNearbySchedule(parsed);
          if (nearby) {
            const confirmText = `${formatScheduleDisplay(nearby)} ã®2æ™‚é–“ä»¥å†…ã«äºˆå®šãŒã‚ã‚Šã¾ã™ã€‚è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ`;
            addMessage('confirm', confirmText, 'warning');
            pendingAction = { type: 'warning', schedule: parsed };
            setInputEnabled(false);
          } else {
            const confirmText = `${formatScheduleDisplay(parsed)} ã‚’è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ`;
            addMessage('confirm', confirmText, 'confirm');
            pendingAction = { type: 'add', schedule: parsed };
            setInputEnabled(false);
          }
        }
      } else {
        addMessage('system', 'æ—¥ä»˜ã‚’èªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã€Œæ¥é€±ã®é‡‘æ›œæ—¥ã€ã€Œæ˜æ—¥ã€ã€Œ1/15ã€ã€Œä»Šæœˆæœ«ã€ãªã©ã‚’å«ã‚ã¦ãã ã•ã„ã€‚');
      }
    });

    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—é–¢æ•°
    function openPopup(id) {
      document.getElementById(id).style.display = 'flex';
    }

    function closePopup(id) {
      document.getElementById(id).style.display = 'none';
    }

    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    document.querySelectorAll('.popup-overlay').forEach(overlay => {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.style.display = 'none';
        }
      });
    });

    // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒœã‚¿ãƒ³
    document.getElementById('helpBtn').addEventListener('click', () => openPopup('helpPopup'));
    document.getElementById('settingsBtn').addEventListener('click', () => openPopup('settingsPopup'));

    // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
    document.getElementById('exportBtn').addEventListener('click', () => {
      if (schedules.length === 0) {
        alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
        return;
      }
      const now = new Date();
      const dateStr = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
      const data = JSON.stringify(schedules, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `yurusuke_backup_${dateStr}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      closePopup('settingsPopup');
      addMessage('system', 'äºˆå®šã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚');
    });

    // ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½
    const importFile = document.getElementById('importFile');
    document.getElementById('importBtn').addEventListener('click', () => {
      importFile.click();
    });

    importFile.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const importedData = JSON.parse(event.target.result);
          if (!Array.isArray(importedData)) {
            alert('ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚');
            return;
          }

          // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
          const choice = confirm('æ—¢å­˜ã®äºˆå®šã«è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ\n\nOK: è¿½åŠ ã™ã‚‹\nã‚­ãƒ£ãƒ³ã‚»ãƒ«: ä¸Šæ›¸ãã™ã‚‹');

          if (choice) {
            // è¿½åŠ ãƒ¢ãƒ¼ãƒ‰ï¼šé‡è¤‡ã‚’é™¤ã„ã¦è¿½åŠ 
            let addedCount = 0;
            importedData.forEach(newSchedule => {
              const isDup = schedules.some(s =>
                s.date === newSchedule.date &&
                s.time === newSchedule.time &&
                s.title === newSchedule.title
              );
              if (!isDup) {
                schedules.push(newSchedule);
                addedCount++;
              }
            });
            localStorage.setItem('schedules', JSON.stringify(schedules));
            closePopup('settingsPopup');
            addMessage('system', `${addedCount}ä»¶ã®äºˆå®šã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚`);
          } else {
            // ä¸Šæ›¸ããƒ¢ãƒ¼ãƒ‰
            if (confirm('æ—¢å­˜ã®äºˆå®šã¯å…¨ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
              schedules = importedData;
              localStorage.setItem('schedules', JSON.stringify(schedules));
              closePopup('settingsPopup');
              addMessage('system', `${importedData.length}ä»¶ã®äºˆå®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚`);
            }
          }
        } catch (err) {
          alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        }
      };
      reader.readAsText(file);
      // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
      importFile.value = '';
    });

    // å…¨ã¦å‰Šé™¤ãƒœã‚¿ãƒ³ï¼ˆ2æ®µéšç¢ºèªï¼‰
    document.getElementById('deleteAllBtn').addEventListener('click', () => {
      if (schedules.length === 0) {
        alert('å‰Šé™¤ã™ã‚‹äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
        return;
      }
      if (confirm('æœ¬å½“ã«å…¨ã¦ã®äºˆå®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        if (confirm('ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
          schedules = [];
          localStorage.setItem('schedules', JSON.stringify(schedules));
          closePopup('settingsPopup');
          addMessage('system', 'å…¨ã¦ã®äºˆå®šã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
        }
      }
    });

    // éŸ³å£°å…¥åŠ›ï¼ˆWeb Speech APIï¼‰
    const voiceBtn = document.getElementById('voiceBtn');
    let recognition = null;

    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = 'ja-JP';
      recognition.continuous = false;
      recognition.interimResults = false;

      recognition.onstart = () => {
        voiceBtn.classList.add('recording');
      };

      recognition.onend = () => {
        voiceBtn.classList.remove('recording');
      };

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        inputField.value = transcript;
        inputField.focus();
      };

      recognition.onerror = (event) => {
        voiceBtn.classList.remove('recording');
        if (event.error !== 'no-speech') {
          addMessage('system', 'éŸ³å£°èªè­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        }
      };

      voiceBtn.addEventListener('click', () => {
        if (voiceBtn.classList.contains('recording')) {
          recognition.stop();
        } else {
          recognition.start();
        }
      });
    } else {
      // éŸ³å£°èªè­˜éå¯¾å¿œ
      voiceBtn.style.display = 'none';
    }

    // åˆæœŸåŒ–
    function initializeApp() {
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const todayStr = `${today.getMonth() + 1}/${today.getDate()}`;

      // éå»ã®äºˆå®šã‚’å‰Šé™¤
      const originalCount = schedules.length;
      schedules = schedules.filter(s => {
        const scheduleDate = new Date(s.fullDate);
        const scheduleDateOnly = new Date(scheduleDate.getFullYear(), scheduleDate.getMonth(), scheduleDate.getDate());
        return scheduleDateOnly >= today;
      });

      const removedCount = originalCount - schedules.length;
      if (removedCount > 0) {
        localStorage.setItem('schedules', JSON.stringify(schedules));
      }

      // å½“æ—¥ã®äºˆå®šã‚’å–å¾—
      const todaySchedules = schedules
        .filter(s => s.date === todayStr)
        .sort((a, b) => getSortableTime(a.time) > getSortableTime(b.time) ? 1 : -1);

      // ä»Šå¾Œã®äºˆå®šï¼ˆå½“æ—¥ä»¥é™ï¼‰
      const futureSchedules = schedules
        .filter(s => s.date !== todayStr)
        .sort((a, b) => {
          const dateA = new Date(a.fullDate);
          const dateB = new Date(b.fullDate);
          if (dateA.getTime() !== dateB.getTime()) return dateA - dateB;
          return getSortableTime(a.time) > getSortableTime(b.time) ? 1 : -1;
        });

      // æŒ¨æ‹¶ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      let greeting = 'ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ï¼<br><br>';

      // å›ºå®šå¹…ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆï¼ˆåŠè§’ã‚¹ãƒšãƒ¼ã‚¹6ã¤ï¼‰
      const INDENT = '      ';

      // æœ¬æ—¥ã®äºˆå®š
      if (todaySchedules.length > 0) {
        greeting += 'æœ¬æ—¥ã®äºˆå®šï¼š<br>';
        const paddedTodayStr = todayStr.padEnd(5, ' ');
        todaySchedules.forEach((s, idx) => {
          const timeStr = s.time ? `${s.time} ` : '';
          if (s.isOther) {
            const content = `(${timeStr}${s.title})`;
            if (idx === 0) {
              greeting += `<span class="other-schedule">${paddedTodayStr} ${content}</span><br>`;
            } else {
              greeting += `<span class="other-schedule">${INDENT}${content}</span><br>`;
            }
          } else {
            const content = `${timeStr}${s.title}`;
            if (idx === 0) {
              greeting += `${paddedTodayStr} ${content}<br>`;
            } else {
              greeting += `${INDENT}${content}<br>`;
            }
          }
        });
      } else {
        greeting += 'æœ¬æ—¥ã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br>';
      }

      // ä»Šå¾Œã®äºˆå®š
      if (futureSchedules.length > 0) {
        greeting += '<br>ä»Šå¾Œã®äºˆå®šï¼š<br>';
        const grouped = {};
        futureSchedules.forEach(s => {
          if (!grouped[s.date]) grouped[s.date] = [];
          grouped[s.date].push(s);
        });
        Object.keys(grouped).forEach(date => {
          const paddedDate = date.padEnd(5, ' ');
          grouped[date].forEach((s, idx) => {
            const timeStr = s.time ? `${s.time} ` : '';
            if (s.isOther) {
              const content = `(${timeStr}${s.title})`;
              if (idx === 0) {
                greeting += `<span class="other-schedule">${paddedDate} ${content}</span><br>`;
              } else {
                greeting += `<span class="other-schedule">${INDENT}${content}</span><br>`;
              }
            } else {
              const content = `${timeStr}${s.title}`;
              if (idx === 0) {
                greeting += `${paddedDate} ${content}<br>`;
              } else {
                greeting += `${INDENT}${content}<br>`;
              }
            }
          });
        });
      }

      addMessage('system', `<div class="schedule-text">${greeting}</div>`);

      // ãƒ€ãƒ–ãƒ«ãƒ–ãƒƒã‚­ãƒ³ã‚°ãƒã‚§ãƒƒã‚¯ï¼ˆåŒã˜æ—¥æ™‚ã«è‡ªåˆ†ã®äºˆå®šãŒè¤‡æ•°ã‚ã‚‹å ´åˆï¼‰
      const doubleBookings = findDoubleBookings();
      if (doubleBookings.length > 0) {
        pendingAction = {
          type: 'resolve-double-booking',
          conflicts: doubleBookings,
          conflictIndex: 0,
          currentConflict: null
        };
        setInputEnabled(false);
        showNextDoubleBooking();
      }
    }

    // ============================================
    // Undoæ©Ÿèƒ½
    // ============================================
    function saveForUndo() {
      undoStack.push(JSON.stringify(schedules));
      if (undoStack.length > MAX_UNDO) {
        undoStack.shift();
      }
    }

    function performUndo() {
      if (undoStack.length === 0) {
        addMessage('system', 'å…ƒã«æˆ»ã™æ“ä½œãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
        return;
      }
      schedules = JSON.parse(undoStack.pop());
      localStorage.setItem('schedules', JSON.stringify(schedules));
      addMessage('system', 'æ“ä½œã‚’å…ƒã«æˆ»ã—ã¾ã—ãŸã€‚');
      showScheduleList();
    }

    // ============================================
    // ç¹°ã‚Šè¿”ã—äºˆå®š
    // ============================================
    function parseRepeatSchedule(input) {
      // ã€Œæ¯é€±ã€ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡º
      const repeatMatch = input.match(/æ¯é€±([æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ])æ›œ?æ—¥?/);
      if (!repeatMatch) return null;

      const weekdayMap = { 'æ—¥': 0, 'æœˆ': 1, 'ç«': 2, 'æ°´': 3, 'æœ¨': 4, 'é‡‘': 5, 'åœŸ': 6 };
      const targetDay = weekdayMap[repeatMatch[1]];

      // æ›œæ—¥éƒ¨åˆ†ã‚’é™¤ã„ãŸæ®‹ã‚Šã‚’è§£æï¼ˆå…ˆé ­ã®ã€Œã®ã€ã€Œã«ã€ã€Œã¯ã€ã‚‚é™¤å»ï¼‰
      let rest = input.replace(/æ¯é€±[æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ]æ›œ?æ—¥?/, '').trim();
      rest = rest.replace(/^[ã®ã«ã¯ã§][\sã€€]*/, '').trim();

      let time = null;
      let title = rest;

      // æ™‚é–“ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡ºï¼ˆè‡ªç„¶èªå¯¾å¿œï¼‰
      // ã€Œ10æ™‚ã‹ã‚‰ã€ã€Œ10æ™‚ã«ã€ã€Œ10æ™‚åŠã‹ã‚‰ã€ã€Œ1000ã€ã€Œ10:00ã€ãªã©
      const timePatterns = [
        /^[\sã€€]*(åˆå‰|åˆå¾Œ)?[\sã€€]*(\d{1,2})[\sã€€]*[:ï¼šæ™‚][\sã€€]*(\d{1,2})?åˆ†?[\sã€€]*(åŠ)?[\sã€€]*(ã‹ã‚‰|ã‚ˆã‚Š|ã«|ã¾ã§)?[\sã€€]*/,
        /^[\sã€€]*(\d{3,4})[\sã€€]*(ã‹ã‚‰|ã‚ˆã‚Š|ã«)?[\sã€€]*/
      ];

      for (const pattern of timePatterns) {
        const timeMatch = rest.match(pattern);
        if (timeMatch) {
          let hours, minutes = 0;

          if (timeMatch[0].match(/\d{3,4}/)) {
            // 1000å½¢å¼
            const numMatch = timeMatch[0].match(/(\d{3,4})/);
            if (numMatch) {
              const num = numMatch[1];
              hours = parseInt(num.slice(0, -2)) || parseInt(num.slice(0, 1));
              minutes = parseInt(num.slice(-2));
            }
          } else {
            // 10æ™‚å½¢å¼
            const ampm = timeMatch[1]; // åˆå‰/åˆå¾Œ
            hours = parseInt(timeMatch[2]);
            if (timeMatch[3]) minutes = parseInt(timeMatch[3]);
            if (timeMatch[4] === 'åŠ') minutes = 30;
            if (ampm === 'åˆå¾Œ' && hours < 12) hours += 12;
            if (ampm === 'åˆå‰' && hours === 12) hours = 0;
          }

          if (!isNaN(hours)) {
            time = String(hours).padStart(2, '0') + String(minutes).padStart(2, '0');
            title = rest.replace(timeMatch[0], '').trim();
            break;
          }
        }
      }

      // ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰ä½™åˆ†ãªåŠ©è©ã‚’é™¤å»
      title = title.replace(/^[ã®ã«ã¯ã§ã€][\sã€€]*/, '').trim();

      if (!title) {
        title = `æ¯é€±${repeatMatch[1]}æ›œã®äºˆå®š`;
      }

      return { targetDay, time, title };
    }

    function generateRepeatSchedules(targetDay, time, title) {
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

      // è¨­å®šã«åŸºã¥ã„ã¦çµ‚äº†æ—¥ã‚’è¨ˆç®—
      const endDate = new Date(today.getFullYear(), today.getMonth() + appSettings.repeatEndMonths + 1, 0);

      const newSchedules = [];
      let current = new Date(today);

      // æœ€åˆã®è©²å½“æ›œæ—¥ã‚’è¦‹ã¤ã‘ã‚‹
      let daysToAdd = targetDay - current.getDay();
      if (daysToAdd < 0) daysToAdd += 7;
      current.setDate(current.getDate() + daysToAdd);

      while (current <= endDate) {
        const dateStr = `${current.getMonth() + 1}/${current.getDate()}`;
        const schedule = {
          date: dateStr,
          time: time,
          title: title,
          fullDate: current.toISOString(),
          isOther: false,
          isRepeat: true
        };

        // é‡è¤‡ãƒã‚§ãƒƒã‚¯
        if (!isDuplicate(schedule)) {
          newSchedules.push(schedule);
        }

        // æ¬¡ã®é€±ã¸
        current.setDate(current.getDate() + 7);
      }

      return newSchedules;
    }

    // ============================================
    // ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼é€šçŸ¥
    // ============================================
    let reminderIntervalId = null;

    function requestNotificationPermission() {
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
      }
    }

    function startReminderCheck() {
      if (reminderIntervalId) clearInterval(reminderIntervalId);

      if (!appSettings.reminderEnabled) return;

      reminderIntervalId = setInterval(checkReminders, 60000); // 1åˆ†ã”ã¨
      checkReminders(); // å³æ™‚å®Ÿè¡Œ
    }

    function checkReminders() {
      if (!appSettings.reminderEnabled) return;
      if (!('Notification' in window) || Notification.permission !== 'granted') return;

      const now = new Date();
      const reminderMs = appSettings.reminderMinutes * 60 * 1000;

      schedules.forEach(s => {
        if (!s.time || s.isOther || s.notified) return;

        const [month, day] = s.date.split('/').map(Number);
        const scheduleDate = new Date(now.getFullYear(), month - 1, day);
        const [hours, minutes] = [parseInt(s.time.slice(0, 2)), parseInt(s.time.slice(2))];
        scheduleDate.setHours(hours, minutes, 0, 0);

        const diff = scheduleDate.getTime() - now.getTime();

        if (diff > 0 && diff <= reminderMs) {
          new Notification('ã‚†ã‚‹ã‚¹ã‚±', {
            body: `${appSettings.reminderMinutes}åˆ†å¾Œ: ${s.title}`,
            icon: 'icon-192.png',
            tag: `${s.date}-${s.time}-${s.title}`
          });
          s.notified = true;
          localStorage.setItem('schedules', JSON.stringify(schedules));
        }
      });
    }

    // ============================================
    // æ¤œç´¢ãƒ»ãƒã‚¤ãƒ©ã‚¤ãƒˆæ©Ÿèƒ½
    // ============================================
    let searchMatches = [];
    let currentMatchIndex = -1;
    let originalMessagesHTML = '';

    function openSearch() {
      document.getElementById('searchOverlay').style.display = 'flex';
      document.getElementById('searchInput').focus();
      originalMessagesHTML = messagesEl.innerHTML;
    }

    function closeSearch() {
      document.getElementById('searchOverlay').style.display = 'none';
      document.getElementById('searchInput').value = '';
      document.getElementById('searchCount').textContent = '';
      if (originalMessagesHTML) {
        messagesEl.innerHTML = originalMessagesHTML;
        originalMessagesHTML = '';
      }
      searchMatches = [];
      currentMatchIndex = -1;
    }

    function performSearch(query) {
      if (!query) {
        if (originalMessagesHTML) {
          messagesEl.innerHTML = originalMessagesHTML;
        }
        document.getElementById('searchCount').textContent = '';
        searchMatches = [];
        return;
      }

      // å…ƒã®HTMLã‚’å¾©å…ƒã—ã¦ã‹ã‚‰æ¤œç´¢
      if (originalMessagesHTML) {
        messagesEl.innerHTML = originalMessagesHTML;
      }

      const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
      searchMatches = [];
      let matchId = 0;

      const messages = messagesEl.querySelectorAll('.message-content');
      messages.forEach(msg => {
        if (msg.textContent.toLowerCase().includes(query.toLowerCase())) {
          msg.innerHTML = msg.innerHTML.replace(regex, (match) => {
            const id = `search-match-${matchId++}`;
            searchMatches.push(id);
            return `<span class="search-highlight" id="${id}">${match}</span>`;
          });
        }
      });

      document.getElementById('searchCount').textContent = searchMatches.length > 0
        ? `${searchMatches.length}ä»¶` : '0ä»¶';

      if (searchMatches.length > 0) {
        currentMatchIndex = 0;
        highlightCurrentMatch();
      }
    }

    function highlightCurrentMatch() {
      document.querySelectorAll('.search-highlight.current').forEach(el => {
        el.classList.remove('current');
      });

      if (currentMatchIndex >= 0 && searchMatches[currentMatchIndex]) {
        const el = document.getElementById(searchMatches[currentMatchIndex]);
        if (el) {
          el.classList.add('current');
          el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }
    }

    function searchNext() {
      if (searchMatches.length === 0) return;
      currentMatchIndex = (currentMatchIndex + 1) % searchMatches.length;
      highlightCurrentMatch();
    }

    function searchPrev() {
      if (searchMatches.length === 0) return;
      currentMatchIndex = (currentMatchIndex - 1 + searchMatches.length) % searchMatches.length;
      highlightCurrentMatch();
    }

    // ============================================
    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼
    // ============================================
    let calendarViewDate = new Date();

    function openCalendar() {
      calendarViewDate = new Date();
      renderCalendar();
      document.getElementById('calendarPopup').style.display = 'flex';
    }

    function changeCalendarMonth(delta) {
      calendarViewDate.setMonth(calendarViewDate.getMonth() + delta);
      renderCalendar();
    }

    function renderCalendar() {
      const year = calendarViewDate.getFullYear();
      const month = calendarViewDate.getMonth();

      document.getElementById('calendarMonthLabel').textContent = `${year}å¹´${month + 1}æœˆ`;

      const grid = document.getElementById('calendarGrid');
      grid.innerHTML = '';

      // æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼
      ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'].forEach(day => {
        const header = document.createElement('div');
        header.className = 'day-header';
        header.textContent = day;
        grid.appendChild(header);
      });

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const today = new Date();
      const todayStr = `${today.getMonth() + 1}/${today.getDate()}`;

      // å‰æœˆã®æ—¥ã‚’åŸ‹ã‚ã‚‹
      for (let i = 0; i < firstDay.getDay(); i++) {
        const prevDate = new Date(year, month, -firstDay.getDay() + i + 1);
        const cell = createDayCell(prevDate, true);
        grid.appendChild(cell);
      }

      // å½“æœˆã®æ—¥
      for (let d = 1; d <= lastDay.getDate(); d++) {
        const date = new Date(year, month, d);
        const cell = createDayCell(date, false);
        grid.appendChild(cell);
      }

      // ç¿Œæœˆã®æ—¥ã‚’åŸ‹ã‚ã‚‹
      const remaining = 42 - grid.children.length;
      for (let i = 1; i <= remaining; i++) {
        const nextDate = new Date(year, month + 1, i);
        const cell = createDayCell(nextDate, true);
        grid.appendChild(cell);
      }
    }

    function createDayCell(date, isOtherMonth) {
      const cell = document.createElement('div');
      cell.className = 'day-cell';
      if (isOtherMonth) cell.classList.add('other-month');

      // æ›œæ—¥ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
      const dayOfWeek = date.getDay();
      if (dayOfWeek === 0) cell.classList.add('sunday');
      if (dayOfWeek === 6) cell.classList.add('saturday');

      const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
      const today = new Date();
      const todayStr = `${today.getMonth() + 1}/${today.getDate()}`;

      if (dateStr === todayStr && date.getFullYear() === today.getFullYear()) {
        cell.classList.add('today');
      }

      const daySchedules = schedules
        .filter(s => s.date === dateStr)
        .sort((a, b) => {
          if (!a.time) return 1;
          if (!b.time) return -1;
          return a.time.localeCompare(b.time);
        });

      // æ—¥ä»˜ç•ªå·
      const dayNumber = document.createElement('span');
      dayNumber.className = 'day-number';
      dayNumber.textContent = date.getDate();
      cell.appendChild(dayNumber);

      // äºˆå®šã‚’è¡¨ç¤ºï¼ˆæœ€å¤§4ä»¶ï¼‰
      const maxShow = 4;
      daySchedules.slice(0, maxShow).forEach(s => {
        const item = document.createElement('div');
        let timeClass = '';
        if (s.time) {
          const hour = parseInt(s.time.slice(0, 2));
          if (hour < 12) timeClass = ' morning';
          else if (hour < 17) timeClass = ' afternoon';
          else timeClass = ' evening';
        }
        item.className = 'schedule-item' + (s.isOther ? ' other' : timeClass);
        const timeStr = s.time ? s.time.slice(0, 2) + ':' + s.time.slice(2) + ' ' : '';
        item.textContent = timeStr + s.title;
        // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ç”¨ãƒ‡ãƒ¼ã‚¿å±æ€§
        item.dataset.tooltip = `${s.time ? s.time.slice(0, 2) + ':' + s.time.slice(2) : 'æ™‚é–“æœªå®š'} ${s.title}`;
        item.addEventListener('mouseenter', showCalendarTooltip);
        item.addEventListener('mouseleave', hideCalendarTooltip);
        cell.appendChild(item);
      });

      // æ®‹ã‚Šã®ä»¶æ•°ã‚’è¡¨ç¤º
      if (daySchedules.length > maxShow) {
        const more = document.createElement('div');
        more.className = 'schedule-more';
        more.textContent = `+${daySchedules.length - maxShow}ä»¶`;
        more.dataset.date = dateStr;
        more.addEventListener('click', () => showDaySchedules(dateStr, daySchedules));
        cell.appendChild(more);
      }

      return cell;
    }

    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—
    let calendarTooltipEl = null;

    function showCalendarTooltip(e) {
      const text = e.target.dataset.tooltip;
      if (!text) return;

      if (!calendarTooltipEl) {
        calendarTooltipEl = document.createElement('div');
        calendarTooltipEl.className = 'calendar-tooltip';
        document.body.appendChild(calendarTooltipEl);
      }

      calendarTooltipEl.textContent = text;
      calendarTooltipEl.style.display = 'block';

      const rect = e.target.getBoundingClientRect();
      calendarTooltipEl.style.left = rect.left + 'px';
      calendarTooltipEl.style.top = (rect.bottom + 5) + 'px';
    }

    function hideCalendarTooltip() {
      if (calendarTooltipEl) {
        calendarTooltipEl.style.display = 'none';
      }
    }

    // æ—¥ä»˜ã®å…¨äºˆå®šã‚’è¡¨ç¤º
    function showDaySchedules(dateStr, daySchedules) {
      const list = daySchedules.map(s => {
        const timeStr = s.time ? s.time.slice(0, 2) + ':' + s.time.slice(2) : 'æœªå®š';
        return `${timeStr} ${s.title}`;
      }).join('\n');
      addMessage('system', `ğŸ“… ${dateStr} ã®äºˆå®š:\n${list}`);
      closePopup('calendarPopup');
    }

    // ============================================
    // iCal ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    // ============================================
    function exportToICal() {
      let ical = 'BEGIN:VCALENDAR\r\n';
      ical += 'VERSION:2.0\r\n';
      ical += 'PRODID:-//ã‚†ã‚‹ã‚¹ã‚±//JP\r\n';
      ical += 'CALSCALE:GREGORIAN\r\n';
      ical += 'METHOD:PUBLISH\r\n';

      schedules.forEach((s, idx) => {
        const date = new Date(s.fullDate);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');

        ical += 'BEGIN:VEVENT\r\n';
        ical += `UID:${idx}-${Date.now()}@yurusuke\r\n`;

        if (s.time && s.time !== 'æœªå®š') {
          const hours = s.time.slice(0, 2);
          const minutes = s.time.slice(2);
          ical += `DTSTART:${year}${month}${day}T${hours}${minutes}00\r\n`;
          ical += `DTEND:${year}${month}${day}T${hours}${minutes}00\r\n`;
        } else {
          ical += `DTSTART;VALUE=DATE:${year}${month}${day}\r\n`;
          ical += `DTEND;VALUE=DATE:${year}${month}${day}\r\n`;
        }

        ical += `SUMMARY:${s.title}\r\n`;
        if (s.isOther) {
          ical += 'DESCRIPTION:ä»–äººã®äºˆå®š\r\n';
        }
        ical += 'END:VEVENT\r\n';
      });

      ical += 'END:VCALENDAR\r\n';

      const blob = new Blob([ical], { type: 'text/calendar;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'yurusuke.ics';
      a.click();
      URL.revokeObjectURL(url);

      addMessage('system', 'Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®è¨­å®šã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚');
      closePopup('settingsPopup');
    }

    // ============================================
    // è¨­å®šé–¢é€£ã‚¤ãƒ™ãƒ³ãƒˆ
    // ============================================
    document.getElementById('calendarBtn').addEventListener('click', openCalendar);

    document.getElementById('reminderToggle').addEventListener('change', async function() {
      if (this.checked) {
        if ('Notification' in window) {
          const permission = await Notification.requestPermission();
          if (permission === 'granted') {
            appSettings.reminderEnabled = true;
            document.getElementById('reminderMinutesRow').style.display = 'flex';
          } else {
            this.checked = false;
            alert('é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã«ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®é€šçŸ¥è¨±å¯ãŒå¿…è¦ã§ã™ã€‚');
            return;
          }
        } else {
          this.checked = false;
          alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯é€šçŸ¥ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚');
          return;
        }
      } else {
        appSettings.reminderEnabled = false;
        document.getElementById('reminderMinutesRow').style.display = 'none';
      }
      localStorage.setItem('appSettings', JSON.stringify(appSettings));
      startReminderCheck();
    });

    document.getElementById('reminderMinutesSelect').addEventListener('change', function() {
      appSettings.reminderMinutes = parseInt(this.value);
      localStorage.setItem('appSettings', JSON.stringify(appSettings));
    });

    document.getElementById('repeatEndMonthsSelect').addEventListener('change', function() {
      appSettings.repeatEndMonths = parseInt(this.value);
      localStorage.setItem('appSettings', JSON.stringify(appSettings));
    });

    document.getElementById('exportIcalBtn').addEventListener('click', exportToICal);

    // è¨­å®šå€¤ã®å¾©å…ƒ
    function restoreSettings() {
      document.getElementById('reminderToggle').checked = appSettings.reminderEnabled;
      document.getElementById('reminderMinutesRow').style.display = appSettings.reminderEnabled ? 'flex' : 'none';
      document.getElementById('reminderMinutesSelect').value = appSettings.reminderMinutes;
      document.getElementById('repeatEndMonthsSelect').value = appSettings.repeatEndMonths;
      updateRepeatPatternsList();
    }

    // å®šæœŸäºˆå®šãƒªã‚¹ãƒˆã®æ›´æ–°
    function updateRepeatPatternsList() {
      const listEl = document.getElementById('repeatPatternsList');
      const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];

      if (repeatPatterns.length === 0) {
        listEl.innerHTML = '<div class="no-patterns">å®šæœŸäºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      listEl.innerHTML = repeatPatterns.map(pattern => {
        const dayName = weekdays[pattern.dayOfWeek];
        // 4æ¡æ•°å­—ï¼ˆ1030ï¼‰ã‚’è¦‹ã‚„ã™ã„å½¢å¼ï¼ˆ10:30ï¼‰ã§è¡¨ç¤º
        let timeStr = 'çµ‚æ—¥';
        if (pattern.time) {
          const t = pattern.time.replace(':', ''); // ã‚³ãƒ­ãƒ³ãŒã‚ã‚Œã°é™¤å»
          if (t.length === 4) {
            timeStr = t.slice(0, 2) + ':' + t.slice(2);
          } else {
            timeStr = pattern.time;
          }
        }
        return `
          <div class="repeat-pattern-item" data-id="${pattern.id}">
            <div class="repeat-pattern-info">
              <span class="repeat-pattern-title">${pattern.title}</span>
              <span class="repeat-pattern-time">æ¯é€±${dayName}æ›œ ${timeStr}</span>
            </div>
            <div class="repeat-pattern-buttons">
              <button class="repeat-pattern-edit" onclick="openEditPatternModal(${pattern.id})">ç·¨é›†</button>
              <button class="repeat-pattern-delete" onclick="deleteRepeatPattern(${pattern.id})">å‰Šé™¤</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // å®šæœŸäºˆå®šã®å‰Šé™¤
    function deleteRepeatPattern(patternId) {
      if (!confirm('ã“ã®å®šæœŸäºˆå®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\\nï¼ˆæ—¢ã«è¿½åŠ ã•ã‚ŒãŸäºˆå®šã¯æ®‹ã‚Šã¾ã™ï¼‰')) return;

      repeatPatterns = repeatPatterns.filter(p => p.id !== patternId);
      localStorage.setItem('repeatPatterns', JSON.stringify(repeatPatterns));
      updateRepeatPatternsList();
    }

    // å®šæœŸäºˆå®šã®ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    let editingPatternId = null;
    function openEditPatternModal(patternId) {
      const pattern = repeatPatterns.find(p => p.id === patternId);
      if (!pattern) return;

      editingPatternId = patternId;

      // ãƒ•ã‚©ãƒ¼ãƒ ã«ç¾åœ¨ã®å€¤ã‚’ã‚»ãƒƒãƒˆ
      document.getElementById('editPatternId').value = patternId;
      document.getElementById('editPatternTitle').value = pattern.title;
      document.getElementById('editPatternDay').value = pattern.dayOfWeek;
      // æ™‚é–“ã‚’è¦‹ã‚„ã™ã„å½¢å¼ï¼ˆ10:30ï¼‰ã§è¡¨ç¤º
      let timeDisplay = pattern.time || '';
      if (timeDisplay && timeDisplay.length === 4 && !timeDisplay.includes(':')) {
        timeDisplay = timeDisplay.slice(0, 2) + ':' + timeDisplay.slice(2);
      }
      document.getElementById('editPatternTime').value = timeDisplay;

      // é©ç”¨é–‹å§‹æ—¥ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ä»Šæ—¥
      const today = new Date();
      const todayStr = today.toISOString().split('T')[0];
      document.getElementById('editPatternFromDate').value = todayStr;

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      document.getElementById('editPatternModal').classList.add('show');
    }

    // å®šæœŸäºˆå®šã®ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeEditPatternModal() {
      document.getElementById('editPatternModal').classList.remove('show');
      editingPatternId = null;
    }

    // å®šæœŸäºˆå®šã®ç·¨é›†ã‚’ä¿å­˜
    function savePatternEdit() {
      const patternId = editingPatternId;
      const pattern = repeatPatterns.find(p => p.id === patternId);
      if (!pattern) return;

      const newTitle = document.getElementById('editPatternTitle').value.trim();
      const newDayOfWeek = parseInt(document.getElementById('editPatternDay').value);
      const newTimeInput = document.getElementById('editPatternTime').value.trim();
      const fromDateStr = document.getElementById('editPatternFromDate').value;

      if (!newTitle) {
        alert('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      // æ™‚é–“ã‚’ãƒ‘ãƒ¼ã‚¹
      const newTime = parseTimeInput(newTimeInput);

      // å¤‰æ›´å‰ã®å€¤ã‚’ä¿å­˜
      const oldTitle = pattern.title;
      const oldDayOfWeek = pattern.dayOfWeek;
      const oldTime = pattern.time;

      // ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ›´æ–°
      pattern.title = newTitle;
      pattern.dayOfWeek = newDayOfWeek;
      pattern.time = newTime;
      localStorage.setItem('repeatPatterns', JSON.stringify(repeatPatterns));

      // æ—¢å­˜ã®äºˆå®šã‚’ä¸€æ‹¬ä¿®æ­£
      const fromDate = fromDateStr ? new Date(fromDateStr) : new Date();
      fromDate.setHours(0, 0, 0, 0);

      let modifiedCount = 0;
      schedules.forEach(s => {
        // ã“ã®å®šæœŸäºˆå®šã‹ã‚‰ç”Ÿæˆã•ã‚ŒãŸäºˆå®šã‹ãƒã‚§ãƒƒã‚¯
        if (s.title === oldTitle && s.time === oldTime && s.isRepeat) {
          const scheduleDate = new Date(s.fullDate);
          const scheduleDayOfWeek = scheduleDate.getDay();

          // æ—§æ›œæ—¥ã«ä¸€è‡´ã—ã€é©ç”¨é–‹å§‹æ—¥ä»¥é™ã®äºˆå®šã‚’ä¿®æ­£
          if (scheduleDayOfWeek === oldDayOfWeek && scheduleDate >= fromDate) {
            // æ–°ã—ã„æ›œæ—¥ã¨ã®å·®åˆ†ã‚’è¨ˆç®—
            let dayDiff = newDayOfWeek - oldDayOfWeek;
            const newScheduleDate = new Date(scheduleDate);
            newScheduleDate.setDate(newScheduleDate.getDate() + dayDiff);

            s.title = newTitle;
            s.time = newTime;
            s.date = `${newScheduleDate.getMonth() + 1}/${newScheduleDate.getDate()}`;
            s.fullDate = newScheduleDate.toISOString();
            modifiedCount++;
          }
        }
      });

      localStorage.setItem('schedules', JSON.stringify(schedules));
      updateRepeatPatternsList();
      closeEditPatternModal();

      // è¨­å®šç”»é¢ã‚’é–‰ã˜ã‚‹
      document.getElementById('settingsScreen').classList.remove('show');

      // å¤‰æ›´å†…å®¹ã‚’ãƒãƒ£ãƒƒãƒˆã«è¡¨ç¤º
      const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
      const oldDayName = weekdays[oldDayOfWeek];
      const newDayName = weekdays[newDayOfWeek];
      const oldTimeDisplay = oldTime ? (oldTime.length === 4 ? oldTime.slice(0, 2) + ':' + oldTime.slice(2) : oldTime) : 'çµ‚æ—¥';
      const newTimeDisplay = newTime ? (newTime.length === 4 ? newTime.slice(0, 2) + ':' + newTime.slice(2) : newTime) : 'çµ‚æ—¥';

      let changeDetails = [];
      if (oldTitle !== newTitle) {
        changeDetails.push(`ã‚¿ã‚¤ãƒˆãƒ«: ${oldTitle} â†’ ${newTitle}`);
      }
      if (oldDayOfWeek !== newDayOfWeek) {
        changeDetails.push(`æ›œæ—¥: ${oldDayName}æ›œ â†’ ${newDayName}æ›œ`);
      }
      if (oldTime !== newTime) {
        changeDetails.push(`æ™‚é–“: ${oldTimeDisplay} â†’ ${newTimeDisplay}`);
      }

      const changeText = changeDetails.length > 0 ? changeDetails.join('ã€') : 'å¤‰æ›´ãªã—';
      const message = `ğŸ“ å®šæœŸäºˆå®šã‚’æ›´æ–°ã—ã¾ã—ãŸ\n${changeText}\nï¼ˆ${modifiedCount}ä»¶ã®äºˆå®šã‚’å¤‰æ›´ï¼‰`;
      addMessage('system', message);

      // äºˆå®šä¸€è¦§ã‚’æ›´æ–°è¡¨ç¤º
      showScheduleList();
    }

    // æ™‚é–“å…¥åŠ›ã‚’4æ¡æ•°å­—å½¢å¼ï¼ˆ1030ç­‰ï¼‰ã«å¤‰æ›
    function parseTimeInput(input) {
      if (!input) return null;

      // 10:30 å½¢å¼
      let match = input.match(/^(\d{1,2}):(\d{2})$/);
      if (match) {
        return `${match[1].padStart(2, '0')}${match[2]}`;
      }

      // 1030 å½¢å¼ï¼ˆæ—¢ã«4æ¡æ•°å­—ï¼‰
      match = input.match(/^(\d{1,2})(\d{2})$/);
      if (match) {
        return `${match[1].padStart(2, '0')}${match[2]}`;
      }

      // 10æ™‚30åˆ† or 10æ™‚åŠ å½¢å¼
      match = input.match(/(\d{1,2})æ™‚(åŠ|(\d{1,2})åˆ†?)?/);
      if (match) {
        const hour = match[1].padStart(2, '0');
        let min = '00';
        if (match[2] === 'åŠ') {
          min = '30';
        } else if (match[3]) {
          min = match[3].padStart(2, '0');
        }
        return `${hour}${min}`;
      }

      return input;
    }

    // å®šæœŸäºˆå®šãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¤œå‡º
    let detectedPatterns = []; // æ¤œå‡ºã•ã‚ŒãŸãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä¿æŒ

    function detectRepeatPatterns() {
      const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];

      // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æ›œæ—¥ãƒ»æ™‚é–“ãƒ»ã‚¿ã‚¤ãƒˆãƒ«ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
      const patternMap = new Map();

      schedules.forEach(s => {
        if (!s.fullDate) return;

        const scheduleDate = new Date(s.fullDate);
        const dayOfWeek = scheduleDate.getDay();
        const time = s.time || 'æœªå®š';
        const title = s.title;

        // ã‚­ãƒ¼ã‚’ä½œæˆï¼ˆæ›œæ—¥-æ™‚é–“-ã‚¿ã‚¤ãƒˆãƒ«ï¼‰
        const key = `${dayOfWeek}-${time}-${title}`;

        if (!patternMap.has(key)) {
          patternMap.set(key, {
            dayOfWeek,
            time,
            title,
            count: 0,
            dates: []
          });
        }

        const pattern = patternMap.get(key);
        pattern.count++;
        pattern.dates.push(s.date);
      });

      // 2å›ä»¥ä¸Šå‡ºç¾ã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æŠ½å‡º
      const candidates = [];
      patternMap.forEach((pattern, key) => {
        if (pattern.count >= 2) {
          candidates.push(pattern);
        }
      });

      // æ—¢ã«ç™»éŒ²æ¸ˆã¿ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é™¤å¤–
      const newPatterns = candidates.filter(candidate => {
        return !repeatPatterns.some(rp =>
          rp.dayOfWeek === candidate.dayOfWeek &&
          rp.time === candidate.time &&
          rp.title === candidate.title
        );
      });

      // å‡ºç¾å›æ•°ã®å¤šã„é †ã«ã‚½ãƒ¼ãƒˆ
      newPatterns.sort((a, b) => b.count - a.count);

      detectedPatterns = newPatterns;

      // çµæœã‚’è¡¨ç¤º
      const listEl = document.getElementById('detectedPatternsList');
      const contentEl = document.getElementById('detectedPatternsContent');

      if (newPatterns.length === 0) {
        contentEl.innerHTML = '<div class="no-detected-patterns">æ–°ã—ã„å®šæœŸãƒ‘ã‚¿ãƒ¼ãƒ³ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
        listEl.style.display = 'block';
        return;
      }

      contentEl.innerHTML = newPatterns.map((pattern, index) => {
        const dayName = weekdays[pattern.dayOfWeek];
        // æ™‚é–“ã‚’è¦‹ã‚„ã™ã„å½¢å¼ï¼ˆ10:30ï¼‰ã§è¡¨ç¤º
        let timeStr = 'æ™‚é–“æœªå®š';
        if (pattern.time && pattern.time !== 'æœªå®š') {
          const t = pattern.time.replace(':', '');
          if (t.length === 4) {
            timeStr = t.slice(0, 2) + ':' + t.slice(2);
          } else {
            timeStr = pattern.time;
          }
        }
        return `
          <div class="detected-pattern-item" id="detected-${index}">
            <div class="detected-pattern-info">
              <div class="detected-pattern-title">${pattern.title}</div>
              <div class="detected-pattern-detail">æ¯é€±${dayName}æ›œ ${timeStr}ï¼ˆ${pattern.count}ä»¶æ¤œå‡ºï¼‰</div>
            </div>
            <button class="detected-pattern-register" onclick="registerDetectedPattern(${index})">ç™»éŒ²</button>
          </div>
        `;
      }).join('');

      listEl.style.display = 'block';
    }

    // æ¤œå‡ºã•ã‚ŒãŸãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç™»éŒ²
    function registerDetectedPattern(index) {
      const pattern = detectedPatterns[index];
      if (!pattern) return;

      // æ—¢ã«ç™»éŒ²æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
      const alreadyRegistered = repeatPatterns.some(rp =>
        rp.dayOfWeek === pattern.dayOfWeek &&
        rp.time === pattern.time &&
        rp.title === pattern.title
      );

      if (alreadyRegistered) {
        return;
      }

      // ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç™»éŒ²
      const newPattern = {
        id: Date.now(),
        dayOfWeek: pattern.dayOfWeek,
        time: pattern.time === 'æœªå®š' ? null : pattern.time,
        title: pattern.title
      };

      repeatPatterns.push(newPattern);
      localStorage.setItem('repeatPatterns', JSON.stringify(repeatPatterns));

      // UIã‚’æ›´æ–°
      updateRepeatPatternsList();

      // ãƒœã‚¿ãƒ³ã‚’ã€Œç™»éŒ²æ¸ˆã¿ã€ã«å¤‰æ›´
      const itemEl = document.getElementById(`detected-${index}`);
      if (itemEl) {
        const btn = itemEl.querySelector('.detected-pattern-register');
        btn.textContent = 'ç™»éŒ²æ¸ˆã¿';
        btn.classList.add('registered');
        btn.onclick = null;
      }

      // æ¤œå‡ºãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¦å†æç”»
      detectedPatterns[index] = null;

      // å…¨ã¦ç™»éŒ²ã•ã‚ŒãŸã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
      const remaining = detectedPatterns.filter(p => p !== null);
      if (remaining.length === 0) {
        setTimeout(() => {
          document.getElementById('detectedPatternsList').style.display = 'none';
        }, 1500);
      }
    }

    // å®šæœŸäºˆå®šã®è‡ªå‹•è£œå……ï¼ˆã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«å‘¼ã°ã‚Œã‚‹ï¼‰
    function replenishRepeatSchedules() {
      if (repeatPatterns.length === 0) return;

      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const endDate = new Date(today.getFullYear(), today.getMonth() + appSettings.repeatEndMonths + 1, 0);

      let addedCount = 0;

      repeatPatterns.forEach(pattern => {
        let current = new Date(today);

        // æœ€åˆã®è©²å½“æ›œæ—¥ã‚’è¦‹ã¤ã‘ã‚‹
        let daysToAdd = pattern.dayOfWeek - current.getDay();
        if (daysToAdd < 0) daysToAdd += 7;
        current.setDate(current.getDate() + daysToAdd);

        while (current <= endDate) {
          const dateStr = `${current.getMonth() + 1}/${current.getDate()}`;
          const schedule = {
            date: dateStr,
            time: pattern.time,
            title: pattern.title,
            fullDate: current.toISOString(),
            isOther: false,
            isRepeat: true
          };

          // é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆåŒã˜æ—¥ä»˜ãƒ»æ™‚é–“ãƒ»ã‚¿ã‚¤ãƒˆãƒ«ã®äºˆå®šãŒãªã‘ã‚Œã°è¿½åŠ ï¼‰
          const exists = schedules.some(s =>
            s.date === schedule.date &&
            s.time === schedule.time &&
            s.title === schedule.title
          );

          if (!exists) {
            schedules.push(schedule);
            addedCount++;
          }

          // æ¬¡ã®é€±ã¸
          current.setDate(current.getDate() + 7);
        }
      });

      if (addedCount > 0) {
        localStorage.setItem('schedules', JSON.stringify(schedules));
        console.log(`å®šæœŸäºˆå®šã‚’${addedCount}ä»¶è£œå……ã—ã¾ã—ãŸ`);
      }
    }

    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
    document.addEventListener('keydown', function(e) {
      // Ctrl+F ã§æ¤œç´¢
      if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault();
        openSearch();
      }
      // Ctrl+Z ã§ Undo
      if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
        e.preventDefault();
        performUndo();
      }
      // Escape ã§æ¤œç´¢é–‰ã˜ã‚‹
      if (e.key === 'Escape') {
        closeSearch();
      }
    });

    // 3æœ¬æŒ‡ã‚¿ãƒƒãƒ—ã§Undoï¼ˆãƒ¢ãƒã‚¤ãƒ«ç”¨ï¼‰
    let touchCount = 0;
    let touchTimer = null;
    document.addEventListener('touchstart', function(e) {
      if (e.touches.length === 3) {
        touchCount++;
        if (touchTimer) clearTimeout(touchTimer);
        touchTimer = setTimeout(() => {
          if (touchCount >= 1) {
            performUndo();
          }
          touchCount = 0;
        }, 300);
      }
    }, { passive: true });

    // æ¤œç´¢å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('searchInput').addEventListener('input', function() {
      performSearch(this.value);
    });

    document.getElementById('searchInput').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        if (e.shiftKey) {
          searchPrev();
        } else {
          searchNext();
        }
      }
    });

    initializeApp();
    replenishRepeatSchedules(); // å®šæœŸäºˆå®šã®è‡ªå‹•è£œå……
    restoreSettings();
    startReminderCheck();

    // Service Workerç™»éŒ²
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .catch(err => console.error('SW registration failed:', err));
    }
  </script>

  <!-- å®šæœŸäºˆå®šç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="editPatternModal" class="edit-pattern-modal">
    <div class="edit-pattern-content">
      <h3>å®šæœŸäºˆå®šã®ç·¨é›†</h3>
      <input type="hidden" id="editPatternId">
      <div class="edit-pattern-field">
        <label>ã‚¿ã‚¤ãƒˆãƒ«</label>
        <input type="text" id="editPatternTitle" placeholder="äºˆå®šã®ã‚¿ã‚¤ãƒˆãƒ«">
      </div>
      <div class="edit-pattern-field">
        <label>æ›œæ—¥</label>
        <select id="editPatternDay">
          <option value="0">æ—¥æ›œæ—¥</option>
          <option value="1">æœˆæ›œæ—¥</option>
          <option value="2">ç«æ›œæ—¥</option>
          <option value="3">æ°´æ›œæ—¥</option>
          <option value="4">æœ¨æ›œæ—¥</option>
          <option value="5">é‡‘æ›œæ—¥</option>
          <option value="6">åœŸæ›œæ—¥</option>
        </select>
      </div>
      <div class="edit-pattern-field">
        <label>æ™‚é–“</label>
        <input type="text" id="editPatternTime" placeholder="ä¾‹: 10:30, 1030, 10æ™‚åŠ">
      </div>
      <div class="edit-pattern-field">
        <label>å¤‰æ›´ã‚’é©ç”¨ã™ã‚‹æ—¥</label>
        <input type="date" id="editPatternFromDate">
        <small>ã“ã®æ—¥ä»¥é™ã®äºˆå®šãŒä¸€æ‹¬å¤‰æ›´ã•ã‚Œã¾ã™</small>
      </div>
      <div class="edit-pattern-actions">
        <button class="edit-pattern-cancel" onclick="closeEditPatternModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="edit-pattern-save" onclick="savePatternEdit()">ä¿å­˜</button>
      </div>
    </div>
  </div>
</body>
</html>
